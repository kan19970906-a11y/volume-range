<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>音域記録帳</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="音域記録">
<meta name="theme-color" content="#0d0d0f">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
<link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
<link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #141418;
    --surface2: #1c1c22;
    --border: #2a2a35;
    --accent: #c8a96e;
    --text: #e8e4dd;
    --muted: #6b6878;
    --chest: #e87060;
    --falsetto: #70a8e8;
    --white-key: #f0ece5;
    --black-key: #1a1a20;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Shippori Mincho', serif;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    padding: max(40px, env(safe-area-inset-top)) 20px max(60px, env(safe-area-inset-bottom));
    padding-left:  max(20px, env(safe-area-inset-left));
    padding-right: max(20px, env(safe-area-inset-right));
    background-image:
      radial-gradient(ellipse at 20% 10%, rgba(200,169,110,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, rgba(126,184,200,0.06) 0%, transparent 50%);
  }

  header { text-align: center; margin-bottom: 48px; }
  header h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    letter-spacing: 0.2em;
    color: var(--accent);
    line-height: 1;
  }
  header p {
    margin-top: 8px;
    color: var(--muted);
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    font-family: 'DM Mono', monospace;
  }

  .container { max-width: 820px; margin: 0 auto; }

  .form-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 36px;
    margin-bottom: 40px;
    position: relative;
    overflow: hidden;
  }
  .form-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
  }
  .form-group { display: flex; flex-direction: column; gap: 8px; }
  .form-group > label {
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }
  input[type="text"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Shippori Mincho', serif;
    font-size: 1rem;
    transition: border-color 0.2s;
    width: 100%;
  }
  input[type="text"]:focus { outline: none; border-color: var(--accent); }

  /* ── Range groups ── */
  .range-inputs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }
  .range-group {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
  }
  .range-group.chest   { border-left: 3px solid var(--chest); }
  .range-group.falsetto{ border-left: 3px solid var(--falsetto); }

  /* header row inside each card */
  .rg-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    gap: 8px;
  }
  .rg-title {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    white-space: nowrap;
  }
  .rg-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .chest   .rg-dot { background: var(--chest); }
  .falsetto .rg-dot { background: var(--falsetto); }

  /* ── "なし" pill ── */
  .none-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 9px 3px 6px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    user-select: none;
    flex-shrink: 0;
  }
  .none-pill:hover { border-color: var(--muted); }
  .none-pill.active { border-color: var(--accent); background: rgba(200,169,110,0.1); }

  .pill-box {
    width: 12px; height: 12px;
    border: 1.5px solid var(--muted);
    border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
    font-size: 8px;
    color: transparent;
    font-weight: bold;
    line-height: 1;
  }
  .none-pill.active .pill-box {
    border-color: var(--accent);
    background: var(--accent);
    color: var(--bg);
  }
  .pill-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    transition: color 0.15s;
  }
  .none-pill.active .pill-text { color: var(--accent); }

  /* ── Note selector row ── */
  .note-selector {
    display: flex;
    gap: 5px;
    align-items: center;
  }
  .note-selector.disabled {
    opacity: 0.25;
    pointer-events: none;
  }
  .note-selector select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    padding: 6px 6px;
    cursor: pointer;
    flex: 1;
    min-width: 0;
  }
  .note-selector select:focus { outline: none; border-color: var(--accent); }

  /* Sharp / flat toggle */
  .acc-btns {
    display: flex;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .acc-btns button {
    background: var(--bg);
    border: none;
    border-right: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    padding: 5px 7px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
    line-height: 1;
  }
  .acc-btns button:last-child { border-right: none; }
  .acc-btns button.sel { background: var(--surface); color: var(--accent); }

  .note-display {
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent);
    min-width: 68px;
    text-align: right;
    flex-shrink: 0;
  }
  .note-display.is-none { color: var(--muted); }

  /* ── Add button ── */
  .btn-add {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), #a88a50);
    border: none;
    border-radius: 10px;
    color: var(--bg);
    font-family: 'Shippori Mincho', serif;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-add:hover { opacity: 0.9; }
  .btn-add:active { transform: scale(0.99); }

  /* ── Piano ── */
  .piano-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 40px;
  }
  .piano-section h2 {
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
  }
  .piano-top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
  }

  /* ── Transpose UI ── */
  .transpose-ui {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tp-btn {
    width: 34px; height: 34px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 1.1rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
    font-family: 'DM Mono', monospace;
  }
  .tp-btn:hover { border-color: var(--accent); color: var(--accent); }
  .tp-btn:active { transform: scale(0.92); }

  .tp-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 44px;
  }
  .tp-num {
    font-family: 'DM Mono', monospace;
    font-size: 1rem;
    font-weight: 500;
    color: var(--accent);
    line-height: 1;
  }
  .tp-num.zero { color: var(--muted); }
  .tp-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-top: 2px;
  }
  .tp-reset {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tp-reset:hover { border-color: var(--accent); color: var(--accent); }

  /* ── Live range display ── */
  .range-display {
    margin-top: 18px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
  }
  .rd-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .rd-item {
    flex: 1;
    min-width: 140px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .rd-label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    white-space: nowrap;
    flex-shrink: 0;
  }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .rd-notes {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
  }
  .rd-note {
    font-family: 'DM Mono', monospace;
    font-size: 0.92rem;
    font-weight: 500;
    color: var(--text);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
    min-width: 54px;
    text-align: center;
    transition: color 0.2s, border-color 0.2s;
  }
  .rd-item.chest   .rd-note { color: var(--chest);   border-color: rgba(232,112,96,0.35); }
  .rd-item.falsetto .rd-note { color: var(--falsetto); border-color: rgba(112,168,232,0.35); }
  .rd-note.is-none { color: var(--muted); border-color: var(--border); font-size: 0.75rem; }
  .rd-arrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
  }
  .piano-scroll { overflow-x: auto; padding-bottom: 8px; }
  .piano-wrap { position: relative; display: inline-block; }
  .piano-labels { position: relative; height: 18px; margin-bottom: 2px; }
  .octave-label {
    position: absolute;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
  }
  .keyboard { position: relative; display: flex; height: 140px; user-select: none; }

  .white-key {
    position: relative;
    width: 32px; height: 140px;
    background: var(--white-key);
    border: 1px solid #aaa;
    border-radius: 0 0 5px 5px;
    display: flex; align-items: flex-end; justify-content: center;
    padding-bottom: 5px;
    font-family: 'DM Mono', monospace;
    font-size: 0.5rem;
    color: #999;
    cursor: default;
    flex-shrink: 0;
    transition: background 0.12s;
    box-shadow: inset 0 -3px 6px rgba(0,0,0,0.08);
  }
  .black-key {
    position: absolute;
    width: 20px; height: 88px;
    background: var(--black-key);
    border-radius: 0 0 4px 4px;
    z-index: 2;
    cursor: default;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.6);
    transition: background 0.12s;
  }

  .key-chest-high    { background: var(--chest) !important; }
  .key-chest-low     { background: color-mix(in srgb, var(--chest) 55%, #fff) !important; }
  .key-falsetto-high { background: var(--falsetto) !important; }
  .key-falsetto-low  { background: color-mix(in srgb, var(--falsetto) 55%, #fff) !important; }
  .key-range-chest   { background: color-mix(in srgb, var(--chest) 28%, var(--white-key)) !important; }
  .key-range-falsetto{ background: color-mix(in srgb, var(--falsetto) 28%, var(--white-key)) !important; }
  .black-key.key-range-chest    { background: color-mix(in srgb, var(--chest) 50%, var(--black-key)) !important; }
  .black-key.key-range-falsetto { background: color-mix(in srgb, var(--falsetto) 50%, var(--black-key)) !important; }

  .piano-legend {
    display: flex; gap: 14px; margin-top: 16px; flex-wrap: wrap;
  }
  .legend-item {
    display: flex; align-items: center; gap: 5px;
    font-size: 0.7rem; color: var(--muted);
    font-family: 'DM Mono', monospace;
  }
  .legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

  /* ── Records ── */
  .records-section h2 { font-size: 1.2rem; letter-spacing: 0.15em; color: var(--accent); margin-bottom: 20px; }
  .record-list { display: flex; flex-direction: column; gap: 14px; }
  .record-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 22px;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: start;
    gap: 14px;
    animation: slideIn 0.25s ease;
    transition: border-color 0.2s;
  }
  .record-card:hover { border-color: var(--accent); }
  .record-card.active { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 6%, var(--surface)); }
  .tap-hint {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    margin-top: 8px;
    letter-spacing: 0.05em;
  }
  .record-card.active .tap-hint { color: var(--accent); }

  /* ── Card action buttons ── */
  .card-actions { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
  .btn-edit {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 5px 12px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-edit:hover { border-color: var(--accent); color: var(--accent); }

  /* ── Edit modal ── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: translateY(16px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  .modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    border-radius: 16px 16px 0 0;
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  .modal-title {
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--accent);
  }
  .btn-modal-close {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 4px 10px;
    font-size: 1rem;
    line-height: 1;
    transition: all 0.2s;
  }
  .btn-modal-close:hover { border-color: var(--muted); color: var(--text); }

  .modal .form-grid { margin-bottom: 20px; }
  .modal .range-inputs { margin-bottom: 20px; }

  .modal-footer { display: flex; gap: 10px; }
  .btn-save {
    flex: 1;
    padding: 12px;
    background: linear-gradient(135deg, var(--accent), #a88a50);
    border: none;
    border-radius: 10px;
    color: var(--bg);
    font-family: 'Shippori Mincho', serif;
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn-save:hover { opacity: 0.9; }
  .btn-cancel {
    padding: 12px 20px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--muted);
    font-family: 'Shippori Mincho', serif;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-cancel:hover { border-color: var(--muted); color: var(--text); }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .record-name { font-size: 1.05rem; font-weight: 600; color: var(--text); margin-bottom: 3px; }
  .record-song { font-size: 0.8rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 10px; }
  .record-ranges { display: flex; flex-wrap: wrap; gap: 7px; }
  .range-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.73rem;
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid;
  }
  .badge-chest {
    color: var(--chest);
    border-color: rgba(232,112,96,0.4);
    background: rgba(232,112,96,0.07);
  }
  .badge-falsetto {
    color: var(--falsetto);
    border-color: rgba(112,168,232,0.4);
    background: rgba(112,168,232,0.07);
  }
  .btn-delete {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 5px 12px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-delete:hover { border-color: var(--chest); color: var(--chest); }
  .empty {
    text-align: center; color: var(--muted);
    font-size: 0.88rem; padding: 40px 0;
    font-family: 'DM Mono', monospace; letter-spacing: 0.1em;
  }

  /* ── Kana row groups ── */
  .kana-group { margin-bottom: 16px; }

  .kana-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 14px;
    cursor: pointer;
    user-select: none;
    margin-bottom: 6px;
  }
  .kana-badge {
    width: 36px; height: 36px;
    border-radius: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem;
    font-weight: 800;
    color: var(--accent);
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .kana-header:hover .kana-badge { border-color: var(--accent); }
  .kana-header.open .kana-badge {
    background: color-mix(in srgb, var(--accent) 15%, var(--surface2));
    border-color: var(--accent);
  }
  .kana-meta {
    flex: 1;
  }
  .kana-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }
  .kana-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    opacity: 0.7;
    margin-top: 1px;
  }
  .kana-chevron {
    font-size: 0.7rem;
    color: var(--muted);
    transition: transform 0.22s;
    font-family: 'DM Mono', monospace;
  }
  .kana-header.open .kana-chevron { transform: rotate(180deg); }

  .kana-body {
    display: none;
    padding-left: 10px;
    border-left: 2px solid var(--border);
    margin-left: 18px;
  }
  .kana-sub {
    color: var(--muted);
    opacity: 0.7;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
  }
  .singer-group { margin-bottom: 12px; }

  .singer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    user-select: none;
  }
  .singer-header:hover { border-color: var(--accent); }
  .singer-header.open {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 5%, var(--surface));
  }

  .singer-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .singer-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #a88a50);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem;
    font-weight: 800;
    color: var(--bg);
    flex-shrink: 0;
    font-family: 'Shippori Mincho', serif;
  }
  .singer-name-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
  }
  .singer-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 2px;
  }

  .singer-header-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .singer-chevron {
    color: var(--muted);
    font-size: 0.75rem;
    transition: transform 0.25s;
    font-family: 'DM Mono', monospace;
  }
  .singer-header.open .singer-chevron { transform: rotate(180deg); }

  .singer-songs {
    display: none;
    flex-direction: column;
    border: 1px solid var(--accent);
    border-top: none;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
  }
  .singer-songs.open { display: flex; }

  /* record-card inside accordion — no border-radius on top */
  .singer-songs .record-card {
    border-radius: 0;
    border: none;
    border-bottom: 1px solid var(--border);
    margin: 0;
    animation: none;
  }
  .singer-songs .record-card:last-child { border-bottom: none; }
  .singer-songs .record-card:hover { background: color-mix(in srgb, var(--accent) 4%, var(--surface)); }
  .singer-songs .record-card.active { background: color-mix(in srgb, var(--accent) 8%, var(--surface)); }

  @media (max-width: 600px) {
    .form-grid, .range-inputs { grid-template-columns: 1fr; }
    .form-card { padding: 22px 18px; }
  }
</style>
</head>
<body>

<header>
  <h1>音域記録帳</h1>
  <p>vocal range logger</p>
</header>

<div class="container">

  <!-- Form -->
  <div class="form-card">
    <div class="form-grid">
      <div class="form-group">
        <label>歌手名</label>
        <input type="text" id="singerName" placeholder="例：山田太郎">
      </div>
      <div class="form-group">
        <label>楽曲名</label>
        <input type="text" id="songName" placeholder="例：〇〇〇〇">
      </div>
    </div>

    <div class="range-inputs">

      <!-- 地声 最高音 — required, no なし -->
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>地声　最高音</div>
        </div>
        <div class="note-selector" id="sel-chestHigh">
          <select id="chestHighPrefix"></select>
          <select id="chestHighNote"></select>
          <div class="acc-btns" id="acc-chestHigh">
            <button data-v="n" class="sel" onclick="setAcc('chestHigh','n')">♮</button>
            <button data-v="s" onclick="setAcc('chestHigh','s')">♯</button>
            <button data-v="f" onclick="setAcc('chestHigh','f')">♭</button>
          </div>
          <span class="note-display" id="disp-chestHigh"></span>
        </div>
      </div>

      <!-- 地声 最低音 — nullable -->
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>地声　最低音</div>
          <div class="none-pill" id="pill-chestLow" onclick="toggleNone('chestLow')">
            <div class="pill-box">✓</div>
            <span class="pill-text">なし</span>
          </div>
        </div>
        <div class="note-selector" id="sel-chestLow">
          <select id="chestLowPrefix"></select>
          <select id="chestLowNote"></select>
          <div class="acc-btns" id="acc-chestLow">
            <button data-v="n" class="sel" onclick="setAcc('chestLow','n')">♮</button>
            <button data-v="s" onclick="setAcc('chestLow','s')">♯</button>
            <button data-v="f" onclick="setAcc('chestLow','f')">♭</button>
          </div>
          <span class="note-display" id="disp-chestLow"></span>
        </div>
      </div>

      <!-- 裏声 最高音 — nullable -->
      <div class="range-group falsetto">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>裏声　最高音</div>
          <div class="none-pill" id="pill-falsettoHigh" onclick="toggleNone('falsettoHigh')">
            <div class="pill-box">✓</div>
            <span class="pill-text">なし</span>
          </div>
        </div>
        <div class="note-selector" id="sel-falsettoHigh">
          <select id="falsettoHighPrefix"></select>
          <select id="falsettoHighNote"></select>
          <div class="acc-btns" id="acc-falsettoHigh">
            <button data-v="n" class="sel" onclick="setAcc('falsettoHigh','n')">♮</button>
            <button data-v="s" onclick="setAcc('falsettoHigh','s')">♯</button>
            <button data-v="f" onclick="setAcc('falsettoHigh','f')">♭</button>
          </div>
          <span class="note-display" id="disp-falsettoHigh"></span>
        </div>
      </div>

      <!-- 裏声 最低音 — nullable -->
      <div class="range-group falsetto">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>裏声　最低音</div>
          <div class="none-pill" id="pill-falsettoLow" onclick="toggleNone('falsettoLow')">
            <div class="pill-box">✓</div>
            <span class="pill-text">なし</span>
          </div>
        </div>
        <div class="note-selector" id="sel-falsettoLow">
          <select id="falsettoLowPrefix"></select>
          <select id="falsettoLowNote"></select>
          <div class="acc-btns" id="acc-falsettoLow">
            <button data-v="n" class="sel" onclick="setAcc('falsettoLow','n')">♮</button>
            <button data-v="s" onclick="setAcc('falsettoLow','s')">♯</button>
            <button data-v="f" onclick="setAcc('falsettoLow','f')">♭</button>
          </div>
          <span class="note-display" id="disp-falsettoLow"></span>
        </div>
      </div>

    </div><!-- .range-inputs -->

    <button class="btn-add" onclick="addRecord()">記録する</button>
  </div>

  <!-- Piano -->
  <div class="piano-section">
    <div class="piano-top-row">
      <h2>鍵盤表示 — <span id="pianoLabel">現在入力中</span></h2>
      <div class="transpose-ui">
        <button class="tp-btn" onclick="changeTranspose(-1)">－</button>
        <div class="tp-display">
          <span class="tp-num" id="transposeNum">±0</span>
          <span class="tp-label">移調</span>
        </div>
        <button class="tp-btn" onclick="changeTranspose(+1)">＋</button>
        <button class="tp-reset" onclick="resetTranspose()">リセット</button>
      </div>
    </div>
    <div class="piano-scroll">
      <div class="piano-wrap">
        <div class="piano-labels" id="pianoLabels"></div>
        <div class="keyboard" id="keyboard"></div>
      </div>
    </div>
    <div class="range-display" id="rangeDisplay">
      <div class="rd-row">
        <div class="rd-item chest">
          <div class="rd-label"><div class="legend-dot" style="background:var(--chest)"></div>地声</div>
          <div class="rd-notes">
            <span class="rd-note" id="rd-chestLow">—</span>
            <span class="rd-arrow">〜</span>
            <span class="rd-note" id="rd-chestHigh">—</span>
          </div>
        </div>
        <div class="rd-item falsetto">
          <div class="rd-label"><div class="legend-dot" style="background:var(--falsetto)"></div>裏声</div>
          <div class="rd-notes">
            <span class="rd-note" id="rd-falsettoLow">—</span>
            <span class="rd-arrow">〜</span>
            <span class="rd-note" id="rd-falsettoHigh">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Records -->
  <div class="records-section">
    <h2>記録一覧</h2>
    <div class="record-list" id="recordList">
      <div class="empty">まだ記録がありません</div>
    </div>
  </div>

</div>

<!-- ── Edit Modal ── -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">編集</div>
      <button class="btn-modal-close" onclick="closeEditModal()">✕</button>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>歌手名</label>
        <input type="text" id="editSingerName" placeholder="例：山田太郎">
      </div>
      <div class="form-group">
        <label>楽曲名</label>
        <input type="text" id="editSongName" placeholder="例：〇〇〇〇">
      </div>
    </div>
    <div class="range-inputs">
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>地声　最高音</div>
        </div>
        <div class="note-selector" id="esel-chestHigh">
          <select id="echestHighPrefix"></select>
          <select id="echestHighNote"></select>
          <div class="acc-btns" id="eacc-chestHigh">
            <button data-v="n" class="sel" onclick="setEditAcc('chestHigh','n')">♮</button>
            <button data-v="s" onclick="setEditAcc('chestHigh','s')">♯</button>
            <button data-v="f" onclick="setEditAcc('chestHigh','f')">♭</button>
          </div>
          <span class="note-display" id="edisp-chestHigh"></span>
        </div>
      </div>
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>地声　最低音</div>
          <div class="none-pill" id="epill-chestLow" onclick="toggleEditNone('chestLow')">
            <div class="pill-box">✓</div><span class="pill-text">なし</span>
          </div>
        </div>
        <div class="note-selector" id="esel-chestLow">
          <select id="echestLowPrefix"></select>
          <select id="echestLowNote"></select>
          <div class="acc-btns" id="eacc-chestLow">
            <button data-v="n" class="sel" onclick="setEditAcc('chestLow','n')">♮</button>
            <button data-v="s" onclick="setEditAcc('chestLow','s')">♯</button>
            <button data-v="f" onclick="setEditAcc('chestLow','f')">♭</button>
          </div>
          <span class="note-display" id="edisp-chestLow"></span>
        </div>
      </div>
      <div class="range-group falsetto">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>裏声　最高音</div>
          <div class="none-pill" id="epill-falsettoHigh" onclick="toggleEditNone('falsettoHigh')">
            <div class="pill-box">✓</div><span class="pill-text">なし</span>
          </div>
        </div>
        <div class="note-selector" id="esel-falsettoHigh">
          <select id="efalsettoHighPrefix"></select>
          <select id="efalsettoHighNote"></select>
          <div class="acc-btns" id="eacc-falsettoHigh">
            <button data-v="n" class="sel" onclick="setEditAcc('falsettoHigh','n')">♮</button>
            <button data-v="s" onclick="setEditAcc('falsettoHigh','s')">♯</button>
            <button data-v="f" onclick="setEditAcc('falsettoHigh','f')">♭</button>
          </div>
          <span class="note-display" id="edisp-falsettoHigh"></span>
        </div>
      </div>
      <div class="range-group falsetto">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>裏声　最低音</div>
          <div class="none-pill" id="epill-falsettoLow" onclick="toggleEditNone('falsettoLow')">
            <div class="pill-box">✓</div><span class="pill-text">なし</span>
          </div>
        </div>
        <div class="note-selector" id="esel-falsettoLow">
          <select id="efalsettoLowPrefix"></select>
          <select id="efalsettoLowNote"></select>
          <div class="acc-btns" id="eacc-falsettoLow">
            <button data-v="n" class="sel" onclick="setEditAcc('falsettoLow','n')">♮</button>
            <button data-v="s" onclick="setEditAcc('falsettoLow','s')">♯</button>
            <button data-v="f" onclick="setEditAcc('falsettoLow','f')">♭</button>
          </div>
          <span class="note-display" id="edisp-falsettoLow"></span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeEditModal()">キャンセル</button>
      <button class="btn-save" onclick="saveEdit()">保存する</button>
    </div>
  </div>
</div>

<script>
// ═══ Note system ════════════════════════════════════
const PREFIXES = [
  { label: '低low', midi: 45 },  // A2=45  (低lowA〜低lowG)
  { label: 'low',   midi: 57 },  // A3=57  (lowA〜lowG)
  { label: 'mid1',  midi: 69 },  // A4=69  (mid1A〜mid1G)
  { label: 'mid2',  midi: 81 },  // A5=81  (mid2A〜mid2G)
  { label: 'hi',    midi: 93 },  // A6=93  (hiA〜hiG)
  { label: 'hihi',  midi: 105 }, // A7=105 (hihiA〜hihiG)
];

const NOTES = [
  { name:'A', semi:0  },  // prefix base = A
  { name:'B', semi:2  },  // B is 2 semitones above A
  { name:'C', semi:3  },  // C above B = A+3
  { name:'D', semi:5  },  // D = A+5
  { name:'E', semi:7  },  // E = A+7
  { name:'F', semi:8  },  // F = A+8
  { name:'G', semi:10 },  // G = A+10
];

const ACC_OFFSET = { n:0, s:+1, f:-1 };
const ACC_LABEL  = { n:'', s:'♯', f:'♭' };

const FIELD_IDS = ['chestHigh','chestLow','falsettoHigh','falsettoLow'];
const accState  = { chestHigh:'n', chestLow:'n', falsettoHigh:'n', falsettoLow:'n' };
const noneState = { chestLow:false, falsettoHigh:false, falsettoLow:false };

// ── Build selects ────────────────────────────────────
function buildSelects() {
  FIELD_IDS.forEach(id => {
    const ps = document.getElementById(id + 'Prefix');
    const ns = document.getElementById(id + 'Note');

    PREFIXES.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = p.label;
      ps.appendChild(o);
    });
    ps.value = id.includes('High') ? 3 : 2;

    NOTES.forEach((n, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = n.name;
      ns.appendChild(o);
    });
    ns.value = 0;

    ps.addEventListener('change', () => { activeRecordId = null; document.querySelectorAll('.record-card').forEach(c=>c.classList.remove('active')); updateDisplay(id); updatePiano(); });
    ns.addEventListener('change', () => { activeRecordId = null; document.querySelectorAll('.record-card').forEach(c=>c.classList.remove('active')); updateDisplay(id); updatePiano(); });
  });
  FIELD_IDS.forEach(updateDisplay);
}

// ── Accidental ───────────────────────────────────────
function setAcc(id, v) {
  accState[id] = v;
  document.querySelectorAll(`#acc-${id} button`).forEach(b => {
    b.classList.toggle('sel', b.dataset.v === v);
  });
  updateDisplay(id);
  updatePiano();
}

// ── None toggle ──────────────────────────────────────
function isNone(id) { return !!noneState[id]; }

function toggleNone(id) {
  noneState[id] = !noneState[id];
  const pill = document.getElementById('pill-' + id);
  const sel  = document.getElementById('sel-'  + id);
  const disp = document.getElementById('disp-' + id);

  pill.classList.toggle('active', noneState[id]);
  if (noneState[id]) {
    sel.classList.add('disabled');
    disp.textContent = 'なし';
    disp.classList.add('is-none');
  } else {
    sel.classList.remove('disabled');
    disp.classList.remove('is-none');
    updateDisplay(id);
  }
  updatePiano();
}

// ── Note name & midi ─────────────────────────────────
function getNoteName(id) {
  if (isNone(id)) return 'なし';
  const pi = parseInt(document.getElementById(id + 'Prefix').value);
  const ni = parseInt(document.getElementById(id + 'Note').value);
  return PREFIXES[pi].label + NOTES[ni].name + ACC_LABEL[accState[id]];
}

function getNoteMidi(id) {
  if (isNone(id)) return null;
  const pi  = parseInt(document.getElementById(id + 'Prefix').value);
  const ni  = parseInt(document.getElementById(id + 'Note').value);
  return Math.max(0, Math.min(127, PREFIXES[pi].midi + NOTES[ni].semi + ACC_OFFSET[accState[id]]));
}

function updateDisplay(id) {
  const disp = document.getElementById('disp-' + id);
  if (!disp) return;
  if (isNone(id)) {
    disp.textContent = 'なし';
    disp.classList.add('is-none');
  } else {
    disp.textContent = getNoteName(id);
    disp.classList.remove('is-none');
  }
}

// MIDI番号 → 日本式音名に変換
function midiToNoteName(midi) {
  if (midi === null) return null;
  // どのprefixグループか（A基点なので prefix.midi <= midi < prefix.midi+12）
  const sorted = [...PREFIXES].sort((a,b) => b.midi - a.midi);
  let prefix = null;
  for (const p of sorted) {
    if (midi >= p.midi) { prefix = p; break; }
  }
  if (!prefix) return null;
  const semi = midi - prefix.midi; // 0〜10の範囲
  const note = NOTES.find(n => n.semi === semi);
  if (note) return prefix.label + note.name;
  // 半音上 = ♯ or 半音下 = ♭ で表現
  const noteSharp = NOTES.find(n => n.semi === semi - 1);
  if (noteSharp) return prefix.label + noteSharp.name + '♯';
  return null;
}

// 音域表示パネルを更新
function updateRangeDisplay(ch, cl, fh, fl) {
  function setText(elId, midi) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (midi === null) {
      el.textContent = 'なし';
      el.classList.add('is-none');
    } else {
      const name = midiToNoteName(midi);
      el.textContent = name || '—';
      el.classList.remove('is-none');
    }
  }
  setText('rd-chestHigh',    ch);
  setText('rd-chestLow',     cl);
  setText('rd-falsettoHigh', fh);
  setText('rd-falsettoLow',  fl);
}

// ═══ Transpose ══════════════════════════════════════
let transposeAmount = 0;

function changeTranspose(delta) {
  const next = transposeAmount + delta;
  if (next < -7 || next > 7) return;
  transposeAmount = next;
  updateTransposeUI();
  // アクティブな記録があればそれを、なければフォームを再描画
  if (activeRecordId !== null) {
    const r = records.find(rec => rec.id === activeRecordId);
    if (r) { loadRecordToPianoMidis(r); return; }
  }
  updatePiano();
}

function resetTranspose() {
  transposeAmount = 0;
  updateTransposeUI();
  if (activeRecordId !== null) {
    const r = records.find(rec => rec.id === activeRecordId);
    if (r) { loadRecordToPianoMidis(r); return; }
  }
  updatePiano();
}

function updateTransposeUI() {
  const num = document.getElementById('transposeNum');
  num.textContent = transposeAmount === 0 ? '±0' : (transposeAmount > 0 ? '+' + transposeAmount : String(transposeAmount));
  num.className = 'tp-num' + (transposeAmount === 0 ? ' zero' : '');
}

// 移調を適用してMIDIを返すヘルパー
function applyTranspose(midi) {
  if (midi === null) return null;
  return midi + transposeAmount;
}

// MIDIを直接受け取って鍵盤を描画する共通関数
function drawPianoMidis(ch, cl, fh, fl) {
  // reset
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const el = document.getElementById('key-' + m);
    if (!el) continue;
    const s = ((m - 12) % 12 + 12) % 12;
    el.className = [1,3,6,8,10].includes(s) ? 'black-key' : 'white-key';
  }

  function mark(midi, cls) {
    if (midi === null) return;
    const el = document.getElementById('key-' + midi);
    if (el) el.classList.add(cls);
  }

  // 移調を適用
  const tch = applyTranspose(ch);
  const tcl = applyTranspose(cl);
  const tfh = applyTranspose(fh);
  const tfl = applyTranspose(fl);

  if (tch !== null && tcl !== null)
    for (let m = Math.min(tch,tcl); m <= Math.max(tch,tcl); m++) mark(m, 'key-range-chest');
  if (tfh !== null && tfl !== null)
    for (let m = Math.min(tfh,tfl); m <= Math.max(tfh,tfl); m++) mark(m, 'key-range-falsetto');

  mark(tch, 'key-chest-high');
  mark(tcl, 'key-chest-low');
  mark(tfh, 'key-falsetto-high');
  mark(tfl, 'key-falsetto-low');

  // 音域表示パネル更新（移調後の音名）
  updateRangeDisplay(tch, tcl, tfh, tfl);
}
const PIANO_START = 45;  // A2
const PIANO_END   = 115; // G7

function buildPiano() {
  const kb  = document.getElementById('keyboard');
  const lbl = document.getElementById('pianoLabels');
  kb.innerHTML = lbl.innerHTML = '';

  const whitePos = {};
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const s = ((m - 12) % 12 + 12) % 12;
    if (![1,3,6,8,10].includes(s)) whitePos[m] = Object.keys(whitePos).length;
  }

  const total = Object.keys(whitePos).length * 32;
  kb.style.width = kb.style.minWidth = total + 'px';
  lbl.style.width = total + 'px';

  // White keys
  Object.entries(whitePos).forEach(([m, wi]) => {
    m = parseInt(m);
    const s = ((m - 12) % 12 + 12) % 12;
    const d = document.createElement('div');
    d.className = 'white-key';
    d.id = 'key-' + m;
    kb.appendChild(d);
  });

  // Black keys
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const s = ((m - 12) % 12 + 12) % 12;
    if (![1,3,6,8,10].includes(s)) continue;
    let prev = null;
    for (let p = m - 1; p >= PIANO_START; p--) {
      if (whitePos[p] !== undefined) { prev = p; break; }
    }
    if (prev === null) continue;
    const d = document.createElement('div');
    d.className = 'black-key';
    d.id = 'key-' + m;
    d.style.left = (whitePos[prev] * 32 + 22) + 'px';
    d.style.top = '0';
    kb.appendChild(d);
  }

  // Labels — show at each A (start of Japanese octave)
  const OCTNAMES = ['低low','low','mid1','mid2','hi','hihi'];
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const s = ((m - 9) % 12 + 12) % 12; // 0 when note is A
    if (s !== 0) continue;
    // which octave group? A2=idx0, A3=idx1 ...
    const octIdx = Math.round((m - 45) / 12);
    if (octIdx < 0 || octIdx >= OCTNAMES.length) continue;
    const wi = whitePos[m];
    if (wi === undefined) continue;
    const sp = document.createElement('span');
    sp.className = 'octave-label';
    sp.style.left = (wi * 32 + 2) + 'px';
    sp.textContent = OCTNAMES[octIdx];
    lbl.appendChild(sp);
  }

  window._whitePos = whitePos;
}

function updatePiano() {
  drawPianoMidis(
    getNoteMidi('chestHigh'),
    getNoteMidi('chestLow'),
    getNoteMidi('falsettoHigh'),
    getNoteMidi('falsettoLow')
  );
}

// ═══ Records ════════════════════════════════════════
let records = JSON.parse(localStorage.getItem('vocalRecords') || '[]');
function saveRecords() { localStorage.setItem('vocalRecords', JSON.stringify(records)); }

function addRecord() {
  const singer = document.getElementById('singerName').value.trim();
  const song   = document.getElementById('songName').value.trim();
  if (!singer && !song) { document.getElementById('singerName').focus(); return; }

  records.unshift({
    id: Date.now(), singer, song,
    chestHigh:    getNoteName('chestHigh'),
    chestLow:     getNoteName('chestLow'),
    falsettoHigh: getNoteName('falsettoHigh'),
    falsettoLow:  getNoteName('falsettoLow'),
  });
  // 追加した歌手のグループを自動で開く
  const singerKey = singer || '（名前なし）';
  openKanaRows.add(getKanaRow(singerKey));
  openSingers.add(singerKey);
  saveRecords();
  renderRecords();
}

function deleteRecord(id) {
  records = records.filter(r => r.id !== id);
  saveRecords();
  renderRecords();
}

function chestBadge(r) {
  if (r.chestLow === 'なし') return `地声　最高音 ${r.chestHigh}`;
  return `地声　${r.chestLow} 〜 ${r.chestHigh}`;
}

function falsettoBadge(r) {
  const bH = r.falsettoHigh === 'なし';
  const bL = r.falsettoLow  === 'なし';
  if (bH && bL) return null;
  if (bH) return `裏声　最低音 ${r.falsettoLow}`;
  if (bL) return `裏声　最高音 ${r.falsettoHigh}`;
  return `裏声　${r.falsettoLow} 〜 ${r.falsettoHigh}`;
}

// 保存済みの音名文字列 → MIDI番号に変換
function noteNameToMidi(name) {
  if (!name || name === 'なし') return null;
  // prefix一覧を長い順にマッチ（"mid2" が "mid" より先にマッチするよう）
  const sorted = [...PREFIXES].sort((a,b) => b.label.length - a.label.length);
  let prefix = null, rest = '';
  for (const p of sorted) {
    if (name.startsWith(p.label)) { prefix = p; rest = name.slice(p.label.length); break; }
  }
  if (!prefix) return null;
  // rest = "A", "B♯", "C♭" など
  const noteName = rest.replace(/[♯♭]/g, '');
  const accChar  = rest.includes('♯') ? 's' : rest.includes('♭') ? 'f' : 'n';
  const note = NOTES.find(n => n.name === noteName);
  if (!note) return null;
  return Math.max(0, Math.min(127, prefix.midi + note.semi + ACC_OFFSET[accChar]));
}

// 記録を鍵盤に反映
let activeRecordId = null;

function loadRecordToPianoMidis(r) {
  drawPianoMidis(
    noteNameToMidi(r.chestHigh),
    noteNameToMidi(r.chestLow),
    noteNameToMidi(r.falsettoHigh),
    noteNameToMidi(r.falsettoLow)
  );
}

function loadRecordToPiano(id) {
  if (activeRecordId === id) {
    activeRecordId = null;
    document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active'));
    document.getElementById('pianoLabel').textContent = '現在入力中';
    updatePiano();
    return;
  }
  activeRecordId = id;
  document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active'));
  document.getElementById('rc-' + id)?.classList.add('active');

  const r = records.find(rec => rec.id === id);
  if (!r) return;

  // ラベル更新
  document.getElementById('pianoLabel').textContent = [r.singer, r.song].filter(Boolean).join(' / ');

  loadRecordToPianoMidis(r);
  document.querySelector('.piano-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ═══ Edit Modal ══════════════════════════════════════
const EDIT_FIELD_IDS = ['chestHigh','chestLow','falsettoHigh','falsettoLow'];
const editAccState  = { chestHigh:'n', chestLow:'n', falsettoHigh:'n', falsettoLow:'n' };
const editNoneState = { chestLow:false, falsettoHigh:false, falsettoLow:false };
let editingRecordId = null;

function buildEditSelects() {
  EDIT_FIELD_IDS.forEach(id => {
    const ps = document.getElementById('e' + id + 'Prefix');
    const ns = document.getElementById('e' + id + 'Note');
    PREFIXES.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = p.label; ps.appendChild(o);
    });
    NOTES.forEach((n, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = n.name; ns.appendChild(o);
    });
    ps.addEventListener('change', () => updateEditDisplay(id));
    ns.addEventListener('change', () => updateEditDisplay(id));
  });
}

function setEditAcc(id, v) {
  editAccState[id] = v;
  document.querySelectorAll(`#eacc-${id} button`).forEach(b => {
    b.classList.toggle('sel', b.dataset.v === v);
  });
  updateEditDisplay(id);
}

function toggleEditNone(id) {
  editNoneState[id] = !editNoneState[id];
  const pill = document.getElementById('epill-' + id);
  const sel  = document.getElementById('esel-' + id);
  const disp = document.getElementById('edisp-' + id);
  pill.classList.toggle('active', editNoneState[id]);
  if (editNoneState[id]) {
    sel.classList.add('disabled');
    disp.textContent = 'なし'; disp.classList.add('is-none');
  } else {
    sel.classList.remove('disabled');
    disp.classList.remove('is-none');
    updateEditDisplay(id);
  }
}

function getEditNoteName(id) {
  if (editNoneState[id]) return 'なし';
  const pi = parseInt(document.getElementById('e' + id + 'Prefix').value);
  const ni = parseInt(document.getElementById('e' + id + 'Note').value);
  return PREFIXES[pi].label + NOTES[ni].name + ACC_LABEL[editAccState[id]];
}

function updateEditDisplay(id) {
  const disp = document.getElementById('edisp-' + id);
  if (!disp) return;
  if (editNoneState[id]) {
    disp.textContent = 'なし'; disp.classList.add('is-none');
  } else {
    disp.textContent = getEditNoteName(id); disp.classList.remove('is-none');
  }
}

// 音名文字列をパースしてモーダルのselectに反映
function parseNoteToModal(id, noteName) {
  const isNoneVal = (!noteName || noteName === 'なし');

  // noneStateをリセット
  editNoneState[id] = false;
  const pill = document.getElementById('epill-' + id);
  const sel  = document.getElementById('esel-' + id);
  const disp = document.getElementById('edisp-' + id);

  if (isNoneVal && id !== 'chestHigh') {
    editNoneState[id] = true;
    if (pill) pill.classList.add('active');
    if (sel)  sel.classList.add('disabled');
    if (disp) { disp.textContent = 'なし'; disp.classList.add('is-none'); }
    return;
  }
  if (pill) pill.classList.remove('active');
  if (sel)  sel.classList.remove('disabled');
  if (disp) disp.classList.remove('is-none');

  // パース
  const sorted = [...PREFIXES].sort((a,b) => b.label.length - a.label.length);
  let prefix = null, rest = '';
  for (const p of sorted) {
    if (noteName.startsWith(p.label)) { prefix = p; rest = noteName.slice(p.label.length); break; }
  }
  const accChar  = rest.includes('♯') ? 's' : rest.includes('♭') ? 'f' : 'n';
  const noteChar = rest.replace(/[♯♭]/g, '');
  const pi = PREFIXES.indexOf(prefix);
  const ni = NOTES.findIndex(n => n.name === noteChar);

  editAccState[id] = accChar;
  document.getElementById('e' + id + 'Prefix').value = pi >= 0 ? pi : 2;
  document.getElementById('e' + id + 'Note').value   = ni >= 0 ? ni : 0;
  document.querySelectorAll(`#eacc-${id} button`).forEach(b => {
    b.classList.toggle('sel', b.dataset.v === accChar);
  });
  updateEditDisplay(id);
}

function openEditModal(id) {
  const r = records.find(rec => rec.id === id);
  if (!r) return;
  editingRecordId = id;

  document.getElementById('editSingerName').value = r.singer || '';
  document.getElementById('editSongName').value   = r.song   || '';

  parseNoteToModal('chestHigh',    r.chestHigh);
  parseNoteToModal('chestLow',     r.chestLow);
  parseNoteToModal('falsettoHigh', r.falsettoHigh);
  parseNoteToModal('falsettoLow',  r.falsettoLow);

  document.getElementById('editModal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  editingRecordId = null;
}

function saveEdit() {
  const idx = records.findIndex(r => r.id === editingRecordId);
  if (idx < 0) return;
  records[idx] = {
    ...records[idx],
    singer:       document.getElementById('editSingerName').value.trim(),
    song:         document.getElementById('editSongName').value.trim(),
    chestHigh:    getEditNoteName('chestHigh'),
    chestLow:     getEditNoteName('chestLow'),
    falsettoHigh: getEditNoteName('falsettoHigh'),
    falsettoLow:  getEditNoteName('falsettoLow'),
  };
  saveRecords();
  closeEditModal();
  // アクティブカードが編集対象なら鍵盤も更新
  if (activeRecordId === editingRecordId) loadRecordToPiano(editingRecordId);
  renderRecords();
}

// オーバーレイクリックで閉じる
document.getElementById('editModal').addEventListener('click', e => {
  if (e.target === document.getElementById('editModal')) closeEditModal();
});

// 開いている行グループを記憶
const openKanaRows = new Set();
const openSingers  = new Set();

// 読みの先頭文字 → 行名マッピング
const KANA_ROWS = [
  { key: 'あ行', label: 'あ行', sub: 'あいうえお', chars: 'あいうえおぁぃぅぇぉアイウエオァィゥェォ' },
  { key: 'か行', label: 'か行', sub: 'かきくけこ', chars: 'かきくけこがぎぐげごカキクケコガギグゲゴ' },
  { key: 'さ行', label: 'さ行', sub: 'さしすせそ', chars: 'さしすせそざじずぜぞサシスセソザジズゼゾ' },
  { key: 'た行', label: 'た行', sub: 'たちつてと', chars: 'たちつてとだぢづでどタチツテトダヂヅデド' },
  { key: 'な行', label: 'な行', sub: 'なにぬねの', chars: 'なにぬねのナニヌネノ' },
  { key: 'は行', label: 'は行', sub: 'はひふへほ', chars: 'はひふへほばびぶべぼぱぴぷぺぽハヒフヘホバビブベボパピプペポ' },
  { key: 'ま行', label: 'ま行', sub: 'まみむめも', chars: 'まみむめもマミムメモ' },
  { key: 'や行', label: 'や行', sub: 'やゆよ',     chars: 'やゆよゃゅょヤユヨャュョ' },
  { key: 'ら行', label: 'ら行', sub: 'らりるれろ', chars: 'らりるれろラリルレロ' },
  { key: 'わ行', label: 'わ行', sub: 'わをん',     chars: 'わをんわをんヲン' },
  { key: 'A-Z',  label: 'A-Z',  sub: 'アルファベット', chars: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz' },
  { key: '0-9',  label: '0-9',  sub: '数字',       chars: '0123456789０１２３４５６７８９' },
  { key: 'その他',label: 'その他',sub: '',          chars: '' },
];
const KANA_ROW_ORDER = KANA_ROWS.map(r => r.key);

function getKanaRow(str) {
  const c = (str || '').charAt(0);
  for (const row of KANA_ROWS) {
    if (row.chars.includes(c)) return row.key;
  }
  return 'その他';
}

function toggleKanaRow(key) {
  openKanaRows.has(key) ? openKanaRows.delete(key) : openKanaRows.add(key);
  renderRecords();
}

function toggleSingerGroup(singerKey) {
  openSingers.has(singerKey) ? openSingers.delete(singerKey) : openSingers.add(singerKey);
  renderRecords();
}

function renderRecords() {
  const list = document.getElementById('recordList');
  if (!records.length) {
    list.innerHTML = '<div class="empty">まだ記録がありません</div>';
    return;
  }
  list.innerHTML = '';

  // 歌手ごとにグループ化
  const singerGroups = {};
  records.forEach(r => {
    const key = r.singer || '（名前なし）';
    if (!singerGroups[key]) singerGroups[key] = [];
    singerGroups[key].push(r);
  });
  // 各歌手の曲を五十音順
  Object.keys(singerGroups).forEach(k => {
    singerGroups[k].sort((a, b) => (a.song || '').localeCompare(b.song || '', 'ja'));
  });

  // 行グループに分類
  const rowGroups = {};
  Object.keys(singerGroups).forEach(singerKey => {
    const row = getKanaRow(singerKey);
    if (!rowGroups[row]) rowGroups[row] = [];
    rowGroups[row].push(singerKey);
  });
  // 行内の歌手も五十音順
  Object.keys(rowGroups).forEach(row => {
    rowGroups[row].sort((a, b) => a.localeCompare(b, 'ja'));
  });

  // 存在する行を決まった順で表示
  const existingRows = KANA_ROW_ORDER.filter(r => rowGroups[r]);

  existingRows.forEach(rowKey => {
    const singers = rowGroups[rowKey];
    const totalSongs = singers.reduce((s, k) => s + singerGroups[k].length, 0);
    const isRowOpen = openKanaRows.has(rowKey);

    const kanaGroup = document.createElement('div');
    kanaGroup.className = 'kana-group';

    // 行ヘッダー
    const rowInfo = KANA_ROWS.find(r => r.key === rowKey) || { label: rowKey, sub: '' };
    const kanaHeader = document.createElement('div');
    kanaHeader.className = 'kana-header' + (isRowOpen ? ' open' : '');
    kanaHeader.innerHTML = `
      <div class="kana-badge">${rowInfo.label.charAt(0)}</div>
      <div class="kana-meta">
        <div class="kana-label">${rowInfo.label}　<span class="kana-sub">${rowInfo.sub}</span></div>
        <div class="kana-count">${singers.length}人・${totalSongs}曲</div>
      </div>
      <span class="kana-chevron">▼</span>
    `;
    kanaHeader.addEventListener('click', () => toggleKanaRow(rowKey));

    // 行ボディ（歌手アコーディオンを含む）
    const kanaBody = document.createElement('div');
    kanaBody.className = 'kana-body' + (isRowOpen ? ' open' : '');

    singers.forEach(singerKey => {
      const singerRecords = singerGroups[singerKey];
      const isSingerOpen = openSingers.has(singerKey);
      const initial = singerKey.charAt(0);

      const group = document.createElement('div');
      group.className = 'singer-group';

      const header = document.createElement('div');
      header.className = 'singer-header' + (isSingerOpen ? ' open' : '');
      header.innerHTML = `
        <div class="singer-header-left">
          <div class="singer-avatar">${initial}</div>
          <div>
            <div class="singer-name-label">${singerKey}</div>
            <div class="singer-count">${singerRecords.length}曲</div>
          </div>
        </div>
        <div class="singer-header-right">
          <span class="singer-chevron">▼</span>
        </div>
      `;
      header.addEventListener('click', () => toggleSingerGroup(singerKey));

      const songs = document.createElement('div');
      songs.className = 'singer-songs' + (isSingerOpen ? ' open' : '');

      singerRecords.forEach(r => {
        const fb = falsettoBadge(r);
        const card = document.createElement('div');
        card.className = 'record-card' + (activeRecordId === r.id ? ' active' : '');
        card.id = 'rc-' + r.id;
        card.innerHTML = `
          <div style="cursor:pointer;flex:1" onclick="loadRecordToPiano(${r.id})">
            <div class="record-song" style="margin-bottom:6px">${r.song || '—'}</div>
            <div class="record-ranges">
              <span class="range-badge badge-chest">${chestBadge(r)}</span>
              ${fb ? `<span class="range-badge badge-falsetto">${fb}</span>` : ''}
            </div>
            <div class="tap-hint">タップして鍵盤に表示</div>
          </div>
          <div class="card-actions">
            <button class="btn-edit"   onclick="event.stopPropagation();openEditModal(${r.id})">編集</button>
            <button class="btn-delete" onclick="event.stopPropagation();deleteRecord(${r.id})">削除</button>
          </div>
        `;
        songs.appendChild(card);
      });

      group.appendChild(header);
      group.appendChild(songs);
      kanaBody.appendChild(group);
    });

    kanaGroup.appendChild(kanaHeader);
    kanaGroup.appendChild(kanaBody);
    list.appendChild(kanaGroup);
  });
}

// ── Init ─────────────────────────────────────────────
buildSelects();
buildEditSelects();
buildPiano();
updatePiano();
renderRecords();

// ── Service Worker ────────────────────────────────────
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
