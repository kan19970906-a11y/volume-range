<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>éŸ³åŸŸè¨˜éŒ²å¸³</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="éŸ³åŸŸè¨˜éŒ²">
<meta name="theme-color" content="#0d0d0f">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
<link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
<link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #141418;
    --surface2: #1c1c22;
    --border: #2a2a35;
    --accent: #c8a96e;
    --text: #e8e4dd;
    --muted: #6b6878;
    --chest: #e87060;
    --falsetto: #70a8e8;
    --white-key: #f0ece5;
    --black-key: #1a1a20;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Shippori Mincho', serif;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    padding: max(40px, env(safe-area-inset-top)) 20px max(60px, env(safe-area-inset-bottom));
    padding-left:  max(20px, env(safe-area-inset-left));
    padding-right: max(20px, env(safe-area-inset-right));
    background-image:
      radial-gradient(ellipse at 20% 10%, rgba(200,169,110,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, rgba(126,184,200,0.06) 0%, transparent 50%);
  }

  header { text-align: center; margin-bottom: 48px; }
  header h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    letter-spacing: 0.2em;
    color: var(--accent);
    line-height: 1;
  }
  header p {
    margin-top: 8px;
    color: var(--muted);
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    font-family: 'DM Mono', monospace;
  }

  .container { max-width: 820px; margin: 0 auto; }

  .form-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 36px;
    margin-bottom: 40px;
    position: relative;
    overflow: hidden;
  }
  .form-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
  }
  .form-group { display: flex; flex-direction: column; gap: 8px; }
  .form-group > label {
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }
  input[type="text"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Shippori Mincho', serif;
    font-size: 1rem;
    transition: border-color 0.2s;
    width: 100%;
  }
  input[type="text"]:focus { outline: none; border-color: var(--accent); }

  /* â”€â”€ Range groups â”€â”€ */
  .range-inputs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }
  .range-group {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
  }
  .range-group.chest   { border-left: 3px solid var(--chest); }
  .range-group.falsetto{ border-left: 3px solid var(--falsetto); }

  /* header row inside each card */
  .rg-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    gap: 8px;
  }
  .rg-title {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    white-space: nowrap;
  }
  .rg-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .chest   .rg-dot { background: var(--chest); }
  .falsetto .rg-dot { background: var(--falsetto); }

  /* â”€â”€ "ãªã—" pill â”€â”€ */
  .none-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 9px 3px 6px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    user-select: none;
    flex-shrink: 0;
  }
  .none-pill:hover { border-color: var(--muted); }
  .none-pill.active { border-color: var(--accent); background: rgba(200,169,110,0.1); }

  .pill-box {
    width: 12px; height: 12px;
    border: 1.5px solid var(--muted);
    border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
    font-size: 8px;
    color: transparent;
    font-weight: bold;
    line-height: 1;
  }
  .none-pill.active .pill-box {
    border-color: var(--accent);
    background: var(--accent);
    color: var(--bg);
  }
  .pill-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    transition: color 0.15s;
  }
  .none-pill.active .pill-text { color: var(--accent); }

  /* â”€â”€ Note selector row â”€â”€ */
  .note-selector {
    display: flex;
    gap: 5px;
    align-items: center;
  }
  .note-selector.disabled {
    opacity: 0.25;
    pointer-events: none;
  }
  .note-selector select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    padding: 6px 6px;
    cursor: pointer;
    flex: 1;
    min-width: 0;
  }
  .note-selector select:focus { outline: none; border-color: var(--accent); }

  /* Sharp / flat toggle */
  .acc-btns {
    display: flex;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .acc-btns button {
    background: var(--bg);
    border: none;
    border-right: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    padding: 5px 7px;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
    line-height: 1;
  }
  .acc-btns button:last-child { border-right: none; }
  .acc-btns button.sel { background: var(--surface); color: var(--accent); }

  .note-display {
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent);
    min-width: 68px;
    text-align: right;
    flex-shrink: 0;
  }
  .note-display.is-none { color: var(--muted); }

  /* â”€â”€ Add button â”€â”€ */
  .btn-add {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), #a88a50);
    border: none;
    border-radius: 10px;
    color: var(--bg);
    font-family: 'Shippori Mincho', serif;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-add:hover { opacity: 0.9; }
  .btn-add:active { transform: scale(0.99); }
  .btn-add.shake {
    animation: shake 0.35s ease;
    background: linear-gradient(135deg, #c0504a, #a03030);
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }
  .duplicate-msg {
    display: none;
    margin-top: 10px;
    padding: 10px 14px;
    background: rgba(192,80,74,0.12);
    border: 1px solid rgba(192,80,74,0.4);
    border-radius: 8px;
    color: #e07070;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    text-align: center;
  }
  .duplicate-msg.show { display: block; }

  /* â”€â”€ Piano â”€â”€ */
  .piano-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 40px;
  }
  .piano-section h2 {
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
  }
  .piano-top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
  }

  /* â”€â”€ Transpose UI â”€â”€ */
  .transpose-ui {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tp-btn {
    width: 34px; height: 34px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 1.1rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
    font-family: 'DM Mono', monospace;
  }
  .tp-btn:hover { border-color: var(--accent); color: var(--accent); }
  .tp-btn:active { transform: scale(0.92); }

  .tp-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 44px;
  }
  .tp-num {
    font-family: 'DM Mono', monospace;
    font-size: 1rem;
    font-weight: 500;
    color: var(--accent);
    line-height: 1;
  }
  .tp-num.zero { color: var(--muted); }
  .tp-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-top: 2px;
  }
  .tp-reset {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tp-reset:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Live range display â”€â”€ */
  .range-display {
    margin-top: 18px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
  }
  .rd-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .rd-item {
    flex: 1;
    min-width: 140px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .rd-label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    white-space: nowrap;
    flex-shrink: 0;
  }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .rd-notes {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
  }
  .rd-note {
    font-family: 'DM Mono', monospace;
    font-size: 0.92rem;
    font-weight: 500;
    color: var(--text);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
    min-width: 54px;
    text-align: center;
    transition: color 0.2s, border-color 0.2s;
  }
  .rd-item.chest   .rd-note { color: var(--chest);   border-color: rgba(232,112,96,0.35); }
  .rd-item.falsetto .rd-note { color: var(--falsetto); border-color: rgba(112,168,232,0.35); }
  .rd-note.is-none { color: var(--muted); border-color: var(--border); font-size: 0.75rem; }
  .rd-arrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
  }
  .piano-scroll { overflow-x: auto; padding-bottom: 8px; }
  .piano-wrap { position: relative; display: inline-block; }
  .piano-labels { position: relative; height: 18px; margin-bottom: 2px; }
  .octave-label {
    position: absolute;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
  }
  .keyboard { position: relative; display: flex; height: 100px; user-select: none; }

  .white-key {
    position: relative;
    width: 22px; height: 100px;
    background: var(--white-key);
    border: 1px solid #aaa;
    border-radius: 0 0 4px 4px;
    display: flex; align-items: flex-end; justify-content: center;
    padding-bottom: 3px;
    font-family: 'DM Mono', monospace;
    font-size: 0.4rem;
    color: #999;
    cursor: default;
    flex-shrink: 0;
    transition: background 0.12s;
    box-shadow: inset 0 -3px 6px rgba(0,0,0,0.08);
  }
  .black-key {
    position: absolute;
    width: 14px; height: 62px;
    background: var(--black-key);
    border-radius: 0 0 3px 3px;
    z-index: 2;
    cursor: default;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.6);
    transition: background 0.12s;
  }

  .key-chest-high    { background: var(--chest) !important; }
  .key-chest-low     { background: color-mix(in srgb, var(--chest) 55%, #fff) !important; }
  .key-falsetto-high { background: var(--falsetto) !important; }
  .key-falsetto-low  { background: color-mix(in srgb, var(--falsetto) 55%, #fff) !important; }
  .key-range-chest   { background: color-mix(in srgb, var(--chest) 28%, var(--white-key)) !important; }
  .key-range-falsetto{ background: color-mix(in srgb, var(--falsetto) 28%, var(--white-key)) !important; }
  .black-key.key-range-chest    { background: color-mix(in srgb, var(--chest) 50%, var(--black-key)) !important; }
  .black-key.key-range-falsetto { background: color-mix(in srgb, var(--falsetto) 50%, var(--black-key)) !important; }

  .piano-legend {
    display: flex; gap: 14px; margin-top: 16px; flex-wrap: wrap;
  }
  .legend-item {
    display: flex; align-items: center; gap: 5px;
    font-size: 0.7rem; color: var(--muted);
    font-family: 'DM Mono', monospace;
  }
  .legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

  /* â”€â”€ Import / Export â”€â”€ */
  .io-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .btn-io {
    flex: 1;
    min-width: 120px;
    padding: 9px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .btn-io:hover { border-color: var(--accent); color: var(--accent); }
  .import-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  .import-modal-overlay.open { display: flex; }
  .import-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 100%;
    max-width: 560px;
    position: relative;
  }
  .import-modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    border-radius: 16px 16px 0 0;
  }
  .import-modal h3 {
    font-size: 0.95rem; font-weight: 600;
    letter-spacing: 0.1em; color: var(--accent);
    margin-bottom: 12px;
  }
  .import-modal p {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem; color: var(--muted);
    margin-bottom: 14px; line-height: 1.6;
  }
  #importTextarea {
    width: 100%;
    height: 160px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    padding: 12px;
    resize: vertical;
    outline: none;
    margin-bottom: 12px;
  }
  #importTextarea:focus { border-color: var(--accent); }
  .import-modal-footer { display: flex; gap: 8px; justify-content: flex-end; }
  .import-result {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    display: none;
  }
  .import-result.ok  { display: block; background: rgba(80,192,120,0.12); border: 1px solid rgba(80,192,120,0.4); color: #60c070; }
  .import-result.err { display: block; background: rgba(192,80,74,0.12);  border: 1px solid rgba(192,80,74,0.4);  color: #e07070; }

  /* â”€â”€ Records â”€â”€ */
  .records-section h2 { font-size: 1.2rem; letter-spacing: 0.15em; color: var(--accent); margin-bottom: 20px; }
  .record-list { display: flex; flex-direction: column; gap: 14px; }
  .record-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 22px;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: start;
    gap: 14px;
    animation: slideIn 0.25s ease;
    transition: border-color 0.2s;
  }
  .record-card:hover { border-color: var(--accent); }
  .record-card.active { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 6%, var(--surface)); }
  .tap-hint {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    margin-top: 8px;
    letter-spacing: 0.05em;
  }
  .record-card.active .tap-hint { color: var(--accent); }

  /* â”€â”€ Card action buttons â”€â”€ */
  .card-actions { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
  .btn-edit {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 5px 12px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-edit:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Edit modal â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: translateY(16px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  .modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    border-radius: 16px 16px 0 0;
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  .modal-title {
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--accent);
  }
  .btn-modal-close {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 4px 10px;
    font-size: 1rem;
    line-height: 1;
    transition: all 0.2s;
  }
  .btn-modal-close:hover { border-color: var(--muted); color: var(--text); }

  .modal .form-grid { margin-bottom: 20px; }
  .modal .range-inputs { margin-bottom: 20px; }

  .modal-footer { display: flex; gap: 10px; }
  .btn-save {
    flex: 1;
    padding: 12px;
    background: linear-gradient(135deg, var(--accent), #a88a50);
    border: none;
    border-radius: 10px;
    color: var(--bg);
    font-family: 'Shippori Mincho', serif;
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn-save:hover { opacity: 0.9; }
  .btn-cancel {
    padding: 12px 20px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--muted);
    font-family: 'Shippori Mincho', serif;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-cancel:hover { border-color: var(--muted); color: var(--text); }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .record-name { font-size: 1.05rem; font-weight: 600; color: var(--text); margin-bottom: 3px; }
  .record-song { font-size: 0.8rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 10px; }
  .record-ranges { display: flex; flex-wrap: wrap; gap: 7px; }
  .range-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.73rem;
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid;
  }
  .badge-chest {
    color: var(--chest);
    border-color: rgba(232,112,96,0.4);
    background: rgba(232,112,96,0.07);
  }
  .badge-falsetto {
    color: var(--falsetto);
    border-color: rgba(112,168,232,0.4);
    background: rgba(112,168,232,0.07);
  }
  .btn-delete {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 5px 12px;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-delete:hover { border-color: var(--chest); color: var(--chest); }
  .empty {
    text-align: center; color: var(--muted);
    font-size: 0.88rem; padding: 40px 0;
    font-family: 'DM Mono', monospace; letter-spacing: 0.1em;
  }

  /* â”€â”€ è¡Œã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã‚è¡Œãƒ»ã‹è¡Œâ€¦ï¼‰ â”€â”€ */
  .kana-group { margin-bottom: 10px; }
  .kana-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
    transition: border-color 0.2s;
  }
  .kana-header:hover { border-color: var(--accent); }
  .kana-header.open {
    border-color: var(--accent);
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    background: color-mix(in srgb, var(--accent) 6%, var(--surface2));
  }
  .kana-badge {
    width: 32px; height: 32px;
    border-radius: 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.95rem; font-weight: 800;
    color: var(--accent);
    flex-shrink: 0;
  }
  .kana-header.open .kana-badge { border-color: var(--accent); }
  .kana-info { flex: 1; }
  .kana-label {
    font-size: 0.88rem; font-weight: 600;
    color: var(--text);
  }
  .kana-sub {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    margin-top: 1px;
  }
  .kana-chevron {
    font-size: 0.65rem; color: var(--muted);
    font-family: 'DM Mono', monospace;
    transition: transform 0.22s;
  }
  .kana-header.open .kana-chevron { transform: rotate(180deg); }
  .kana-body {
    display: none;
    border: 1px solid var(--accent);
    border-top: none;
    border-radius: 0 0 10px 10px;
    padding: 8px;
    background: color-mix(in srgb, var(--accent) 2%, var(--bg));
  }
  .kana-body.open { display: block; }

  /* â”€â”€ ä¸­é–“å±¤ï¼šã•ãƒ»ã—ãƒ»ã™ãƒ»ã›ãƒ»ã â”€â”€ */
  .char-group { margin-bottom: 6px; }
  .char-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    transition: border-color 0.15s, background 0.15s;
  }
  .char-header:hover { border-color: var(--accent); }
  .char-header.open {
    border-color: var(--accent);
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    background: color-mix(in srgb, var(--accent) 4%, var(--surface));
  }
  .char-badge {
    font-size: 1rem; font-weight: 800;
    color: var(--accent);
    width: 22px; text-align: center; flex-shrink: 0;
  }
  .char-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem; color: var(--muted); flex: 1;
  }
  .char-chevron {
    font-size: 0.6rem; color: var(--muted);
    font-family: 'DM Mono', monospace;
    transition: transform 0.2s;
  }
  .char-header.open .char-chevron { transform: rotate(180deg); }
  .char-body {
    display: none;
    border: 1px solid var(--accent);
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 6px;
    background: color-mix(in srgb, var(--accent) 2%, var(--bg));
  }
  .char-body.open { display: block; }

  /* â”€â”€ Singer accordion â”€â”€ */
  .singer-group { margin-bottom: 12px; }

  .singer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    user-select: none;
  }
  .singer-header:hover { border-color: var(--accent); }
  .singer-header.open {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 5%, var(--surface));
  }

  .singer-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .singer-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #a88a50);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem;
    font-weight: 800;
    color: var(--bg);
    flex-shrink: 0;
    font-family: 'Shippori Mincho', serif;
  }
  .singer-name-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
  }
  .singer-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 2px;
  }

  .singer-header-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .singer-chevron {
    color: var(--muted);
    font-size: 0.75rem;
    transition: transform 0.25s;
    font-family: 'DM Mono', monospace;
  }
  .singer-header.open .singer-chevron { transform: rotate(180deg); }

  .singer-songs {
    display: none;
    flex-direction: column;
    border: 1px solid var(--accent);
    border-top: none;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
  }
  .singer-songs.open { display: flex; }

  /* record-card inside accordion â€” no border-radius on top */
  .singer-songs .record-card {
    border-radius: 0;
    border: none;
    border-bottom: 1px solid var(--border);
    margin: 0;
    animation: none;
  }
  .singer-songs .record-card:last-child { border-bottom: none; }
  .singer-songs .record-card:hover { background: color-mix(in srgb, var(--accent) 4%, var(--surface)); }
  .singer-songs .record-card.active { background: color-mix(in srgb, var(--accent) 8%, var(--surface)); }

  /* â”€â”€ æ›²åè¡Œã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ â”€â”€ */
  .song-row-group { border-bottom: 1px solid var(--border); }
  .song-row-group:last-child { border-bottom: none; }
  .song-row-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 16px;
    background: color-mix(in srgb, var(--accent) 3%, var(--surface));
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }
  .song-row-header:hover { background: color-mix(in srgb, var(--accent) 7%, var(--surface)); }
  .song-row-badge {
    font-size: 0.78rem; font-weight: 800;
    color: var(--accent); width: 28px; text-align: center; flex-shrink: 0;
  }
  .song-row-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem; color: var(--muted); flex: 1;
  }
  .song-row-chevron {
    font-size: 0.55rem; color: var(--muted);
    font-family: 'DM Mono', monospace;
    transition: transform 0.18s;
  }
  .song-row-header.open .song-row-chevron { transform: rotate(180deg); }
  .song-row-body { display: none; }
  .song-row-body.open { display: block; }

  @media (max-width: 600px) {
    .form-grid, .range-inputs { grid-template-columns: 1fr; }
    .form-card { padding: 22px 18px; }
  }
</style>
</head>
<body>

<header>
  <h1>éŸ³åŸŸè¨˜éŒ²å¸³</h1>
  <p>vocal range logger</p>
</header>

<div class="container">

  <!-- Form -->
  <div class="form-card">
    <div class="form-grid">
      <div class="form-group">
        <label>æ­Œæ‰‹å</label>
        <input type="text" id="singerName" placeholder="ä¾‹ï¼šã‚·ãƒ‰">
      </div>
      <div class="form-group">
        <label>æ¥½æ›²å</label>
        <input type="text" id="songName" placeholder="ä¾‹ï¼šèª˜æ„Ÿã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³">
      </div>
    </div>

    <div class="range-inputs">

      <!-- åœ°å£° æœ€é«˜éŸ³ â€” required, no ãªã— -->
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>åœ°å£°ã€€æœ€é«˜éŸ³</div>
        </div>
        <div class="note-selector" id="sel-chestHigh">
          <select id="chestHighPrefix"></select>
          <select id="chestHighNote"></select>
          <div class="acc-btns" id="acc-chestHigh">
            <button data-v="n" class="sel" onclick="setAcc('chestHigh','n')">â™®</button>
            <button data-v="s" onclick="setAcc('chestHigh','s')">â™¯</button>
            <button data-v="f" onclick="setAcc('chestHigh','f')">â™­</button>
          </div>
          <span class="note-display" id="disp-chestHigh"></span>
        </div>
      </div>

      <!-- åœ°å£° æœ€ä½éŸ³ â€” nullable -->
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>åœ°å£°ã€€æœ€ä½éŸ³</div>
          <div class="none-pill" id="pill-chestLow" onclick="toggleNone('chestLow')">
            <div class="pill-box">âœ“</div>
            <span class="pill-text">ãªã—</span>
          </div>
        </div>
        <div class="note-selector" id="sel-chestLow">
          <select id="chestLowPrefix"></select>
          <select id="chestLowNote"></select>
          <div class="acc-btns" id="acc-chestLow">
            <button data-v="n" class="sel" onclick="setAcc('chestLow','n')">â™®</button>
            <button data-v="s" onclick="setAcc('chestLow','s')">â™¯</button>
            <button data-v="f" onclick="setAcc('chestLow','f')">â™­</button>
          </div>
          <span class="note-display" id="disp-chestLow"></span>
        </div>
      </div>

      <!-- è£å£° æœ€é«˜éŸ³ â€” nullable -->
      <div class="range-group falsetto">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>è£å£°ã€€æœ€é«˜éŸ³</div>
          <div class="none-pill" id="pill-falsettoHigh" onclick="toggleNone('falsettoHigh')">
            <div class="pill-box">âœ“</div>
            <span class="pill-text">ãªã—</span>
          </div>
        </div>
        <div class="note-selector" id="sel-falsettoHigh">
          <select id="falsettoHighPrefix"></select>
          <select id="falsettoHighNote"></select>
          <div class="acc-btns" id="acc-falsettoHigh">
            <button data-v="n" class="sel" onclick="setAcc('falsettoHigh','n')">â™®</button>
            <button data-v="s" onclick="setAcc('falsettoHigh','s')">â™¯</button>
            <button data-v="f" onclick="setAcc('falsettoHigh','f')">â™­</button>
          </div>
          <span class="note-display" id="disp-falsettoHigh"></span>
        </div>
      </div>

    </div><!-- .range-inputs -->

    <button class="btn-add" id="btnAdd" onclick="addRecord()">è¨˜éŒ²ã™ã‚‹</button>
    <div class="duplicate-msg" id="duplicateMsg">ã“ã®æ­Œæ‰‹ãƒ»æ›²åã®çµ„ã¿åˆã‚ã›ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™</div>
  </div>

  <!-- Piano -->
  <div class="piano-section">
    <div class="piano-top-row">
      <h2>éµç›¤è¡¨ç¤º â€” <span id="pianoLabel">ç¾åœ¨å…¥åŠ›ä¸­</span></h2>
      <div class="transpose-ui">
        <button class="tp-btn" onclick="changeTranspose(-1)">ï¼</button>
        <div class="tp-display">
          <span class="tp-num" id="transposeNum">Â±0</span>
          <span class="tp-label">ç§»èª¿</span>
        </div>
        <button class="tp-btn" onclick="changeTranspose(+1)">ï¼‹</button>
        <button class="tp-reset" onclick="resetTranspose()">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
    <div class="piano-scroll">
      <div class="piano-wrap">
        <div class="piano-labels" id="pianoLabels"></div>
        <div class="keyboard" id="keyboard"></div>
      </div>
    </div>
    <div class="range-display" id="rangeDisplay">
      <div class="rd-row">
        <div class="rd-item chest">
          <div class="rd-label"><div class="legend-dot" style="background:var(--chest)"></div>åœ°å£°</div>
          <div class="rd-notes">
            <span class="rd-note" id="rd-chestLow">â€”</span>
            <span class="rd-arrow">ã€œ</span>
            <span class="rd-note" id="rd-chestHigh">â€”</span>
          </div>
        </div>
        <div class="rd-item falsetto">
          <div class="rd-label"><div class="legend-dot" style="background:var(--falsetto)"></div>è£å£°</div>
          <div class="rd-notes">
            <span class="rd-note" id="rd-falsettoHigh">â€”</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Records -->
  <div class="records-section">
    <h2>è¨˜éŒ²ä¸€è¦§</h2>
    <div class="io-bar">
      <button class="btn-io" onclick="openImportModal()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="btn-io" onclick="exportRecords()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
    <div class="record-list" id="recordList">
      <div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>

</div>

<!-- â”€â”€ Import Modal â”€â”€ -->
<div class="import-modal-overlay" id="importModal">
  <div class="import-modal">
    <h3>JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
    <p>Claudeã«JSONã‚’å‡ºåŠ›ã—ã¦ã‚‚ã‚‰ã„ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>é‡è¤‡ã™ã‚‹æ›²ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚</p>
    <div class="import-result" id="importResult"></div>
    <textarea id="importTextarea" placeholder='[{"singer":"ã‚·ãƒ‰","song":"å˜˜","chestHigh":"hiC","chestLow":"mid1Fâ™¯","falsettoHigh":"hiD"}]'></textarea>
    <div class="import-modal-footer">
      <button class="btn-cancel" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="doImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Edit Modal â”€â”€ -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ç·¨é›†</div>
      <button class="btn-modal-close" onclick="closeEditModal()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>æ­Œæ‰‹å</label>
        <input type="text" id="editSingerName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
      </div>
      <div class="form-group">
        <label>æ¥½æ›²å</label>
        <input type="text" id="editSongName" placeholder="ä¾‹ï¼šã€‡ã€‡ã€‡ã€‡">
      </div>
    </div>
    <div class="range-inputs">
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>åœ°å£°ã€€æœ€é«˜éŸ³</div>
        </div>
        <div class="note-selector" id="esel-chestHigh">
          <select id="echestHighPrefix"></select>
          <select id="echestHighNote"></select>
          <div class="acc-btns" id="eacc-chestHigh">
            <button data-v="n" class="sel" onclick="setEditAcc('chestHigh','n')">â™®</button>
            <button data-v="s" onclick="setEditAcc('chestHigh','s')">â™¯</button>
            <button data-v="f" onclick="setEditAcc('chestHigh','f')">â™­</button>
          </div>
          <span class="note-display" id="edisp-chestHigh"></span>
        </div>
      </div>
      <div class="range-group chest">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>åœ°å£°ã€€æœ€ä½éŸ³</div>
          <div class="none-pill" id="epill-chestLow" onclick="toggleEditNone('chestLow')">
            <div class="pill-box">âœ“</div><span class="pill-text">ãªã—</span>
          </div>
        </div>
        <div class="note-selector" id="esel-chestLow">
          <select id="echestLowPrefix"></select>
          <select id="echestLowNote"></select>
          <div class="acc-btns" id="eacc-chestLow">
            <button data-v="n" class="sel" onclick="setEditAcc('chestLow','n')">â™®</button>
            <button data-v="s" onclick="setEditAcc('chestLow','s')">â™¯</button>
            <button data-v="f" onclick="setEditAcc('chestLow','f')">â™­</button>
          </div>
          <span class="note-display" id="edisp-chestLow"></span>
        </div>
      </div>
      <div class="range-group falsetto">
        <div class="rg-header">
          <div class="rg-title"><div class="rg-dot"></div>è£å£°ã€€æœ€é«˜éŸ³</div>
          <div class="none-pill" id="epill-falsettoHigh" onclick="toggleEditNone('falsettoHigh')">
            <div class="pill-box">âœ“</div><span class="pill-text">ãªã—</span>
          </div>
        </div>
        <div class="note-selector" id="esel-falsettoHigh">
          <select id="efalsettoHighPrefix"></select>
          <select id="efalsettoHighNote"></select>
          <div class="acc-btns" id="eacc-falsettoHigh">
            <button data-v="n" class="sel" onclick="setEditAcc('falsettoHigh','n')">â™®</button>
            <button data-v="s" onclick="setEditAcc('falsettoHigh','s')">â™¯</button>
            <button data-v="f" onclick="setEditAcc('falsettoHigh','f')">â™­</button>
          </div>
          <span class="note-display" id="edisp-falsettoHigh"></span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
// â•â•â• Note system â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PREFIXES = [
  { label: 'ä½low', midi: 45 },  // A2=45  (ä½lowAã€œä½lowG)
  { label: 'low',   midi: 57 },  // A3=57  (lowAã€œlowG)
  { label: 'mid1',  midi: 69 },  // A4=69  (mid1Aã€œmid1G)
  { label: 'mid2',  midi: 81 },  // A5=81  (mid2Aã€œmid2G)
  { label: 'hi',    midi: 93 },  // A6=93  (hiAã€œhiG)
  { label: 'hihi',  midi: 105 }, // A7=105 (hihiAã€œhihiG)
];

const NOTES = [
  { name:'A', semi:0  },  // prefix base = A
  { name:'B', semi:2  },  // B is 2 semitones above A
  { name:'C', semi:3  },  // C above B = A+3
  { name:'D', semi:5  },  // D = A+5
  { name:'E', semi:7  },  // E = A+7
  { name:'F', semi:8  },  // F = A+8
  { name:'G', semi:10 },  // G = A+10
];

const ACC_OFFSET = { n:0, s:+1, f:-1 };
const ACC_LABEL  = { n:'', s:'â™¯', f:'â™­' };

const FIELD_IDS = ['chestHigh','chestLow','falsettoHigh'];
const accState  = { chestHigh:'n', chestLow:'n', falsettoHigh:'n' };
const noneState = { chestLow:false, falsettoHigh:false };

// â”€â”€ Build selects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSelects() {
  FIELD_IDS.forEach(id => {
    const ps = document.getElementById(id + 'Prefix');
    const ns = document.getElementById(id + 'Note');

    PREFIXES.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = p.label;
      ps.appendChild(o);
    });

    NOTES.forEach((n, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = n.name;
      ns.appendChild(o);
    });

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼šã‚·ãƒ‰ã€Œèª˜æ„Ÿã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ã®ä¾‹ã«åˆã‚ã›ã‚‹
    if (id === 'chestHigh')     { ps.value = 4; ns.value = 2; }           // hiC
    else if (id === 'chestLow') { ps.value = 2; ns.value = 5; accState['chestLow'] = 's'; } // mid1Fâ™¯
    else if (id === 'falsettoHigh') { ps.value = 4; ns.value = 3; }       // hiD

    ps.addEventListener('change', () => { activeRecordId = null; document.querySelectorAll('.record-card').forEach(c=>c.classList.remove('active')); updateDisplay(id); updatePiano(); });
    ns.addEventListener('change', () => { activeRecordId = null; document.querySelectorAll('.record-card').forEach(c=>c.classList.remove('active')); updateDisplay(id); updatePiano(); });
  });
  // chestLow ã®â™¯ãƒœã‚¿ãƒ³ã‚’åˆæœŸé¸æŠçŠ¶æ…‹ã«ã™ã‚‹
  document.querySelectorAll('#acc-chestLow button').forEach(b => {
    b.classList.toggle('sel', b.dataset.v === 's');
  });
  FIELD_IDS.forEach(updateDisplay);
}

// â”€â”€ Accidental â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAcc(id, v) {
  accState[id] = v;
  document.querySelectorAll(`#acc-${id} button`).forEach(b => {
    b.classList.toggle('sel', b.dataset.v === v);
  });
  updateDisplay(id);
  updatePiano();
}

// â”€â”€ None toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isNone(id) { return !!noneState[id]; }

function toggleNone(id) {
  noneState[id] = !noneState[id];
  const pill = document.getElementById('pill-' + id);
  const sel  = document.getElementById('sel-'  + id);
  const disp = document.getElementById('disp-' + id);

  pill.classList.toggle('active', noneState[id]);
  if (noneState[id]) {
    sel.classList.add('disabled');
    disp.textContent = 'ãªã—';
    disp.classList.add('is-none');
  } else {
    sel.classList.remove('disabled');
    disp.classList.remove('is-none');
    updateDisplay(id);
  }
  updatePiano();
}

// â”€â”€ Note name & midi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getNoteName(id) {
  if (isNone(id)) return 'ãªã—';
  const pi = parseInt(document.getElementById(id + 'Prefix').value);
  const ni = parseInt(document.getElementById(id + 'Note').value);
  return PREFIXES[pi].label + NOTES[ni].name + ACC_LABEL[accState[id]];
}

function getNoteMidi(id) {
  if (isNone(id)) return null;
  const pi  = parseInt(document.getElementById(id + 'Prefix').value);
  const ni  = parseInt(document.getElementById(id + 'Note').value);
  return Math.max(0, Math.min(127, PREFIXES[pi].midi + NOTES[ni].semi + ACC_OFFSET[accState[id]]));
}

function updateDisplay(id) {
  const disp = document.getElementById('disp-' + id);
  if (!disp) return;
  if (isNone(id)) {
    disp.textContent = 'ãªã—';
    disp.classList.add('is-none');
  } else {
    disp.textContent = getNoteName(id);
    disp.classList.remove('is-none');
  }
}

// MIDIç•ªå· â†’ æ—¥æœ¬å¼éŸ³åã«å¤‰æ›
function midiToNoteName(midi) {
  if (midi === null) return null;
  // ã©ã®prefixã‚°ãƒ«ãƒ¼ãƒ—ã‹ï¼ˆAåŸºç‚¹ãªã®ã§ prefix.midi <= midi < prefix.midi+12ï¼‰
  const sorted = [...PREFIXES].sort((a,b) => b.midi - a.midi);
  let prefix = null;
  for (const p of sorted) {
    if (midi >= p.midi) { prefix = p; break; }
  }
  if (!prefix) return null;
  const semi = midi - prefix.midi; // 0ã€œ10ã®ç¯„å›²
  const note = NOTES.find(n => n.semi === semi);
  if (note) return prefix.label + note.name;
  // åŠéŸ³ä¸Š = â™¯ or åŠéŸ³ä¸‹ = â™­ ã§è¡¨ç¾
  const noteSharp = NOTES.find(n => n.semi === semi - 1);
  if (noteSharp) return prefix.label + noteSharp.name + 'â™¯';
  return null;
}

// éŸ³åŸŸè¡¨ç¤ºãƒ‘ãƒãƒ«ã‚’æ›´æ–°
function updateRangeDisplay(ch, cl, fh) {
  function setText(elId, midi) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (midi === null) {
      el.textContent = 'ãªã—';
      el.classList.add('is-none');
    } else {
      const name = midiToNoteName(midi);
      el.textContent = name || 'â€”';
      el.classList.remove('is-none');
    }
  }
  setText('rd-chestHigh',    ch);
  setText('rd-chestLow',     cl);
  setText('rd-falsettoHigh', fh);
}

// â•â•â• Transpose â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let transposeAmount = 0;

function changeTranspose(delta) {
  const next = transposeAmount + delta;
  if (next < -7 || next > 7) return;
  transposeAmount = next;
  updateTransposeUI();
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¨˜éŒ²ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ ã‚’å†æç”»
  if (activeRecordId !== null) {
    const r = records.find(rec => rec.id === activeRecordId);
    if (r) { loadRecordToPianoMidis(r); return; }
  }
  updatePiano();
}

function resetTranspose() {
  transposeAmount = 0;
  updateTransposeUI();
  if (activeRecordId !== null) {
    const r = records.find(rec => rec.id === activeRecordId);
    if (r) { loadRecordToPianoMidis(r); return; }
  }
  updatePiano();
}

function updateTransposeUI() {
  const num = document.getElementById('transposeNum');
  num.textContent = transposeAmount === 0 ? 'Â±0' : (transposeAmount > 0 ? '+' + transposeAmount : String(transposeAmount));
  num.className = 'tp-num' + (transposeAmount === 0 ? ' zero' : '');
}

// ç§»èª¿ã‚’é©ç”¨ã—ã¦MIDIã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
function applyTranspose(midi) {
  if (midi === null) return null;
  return midi + transposeAmount;
}

// MIDIã‚’ç›´æ¥å—ã‘å–ã£ã¦éµç›¤ã‚’æç”»ã™ã‚‹å…±é€šé–¢æ•°
function drawPianoMidis(ch, cl, fh) {
  // reset
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const el = document.getElementById('key-' + m);
    if (!el) continue;
    const s = ((m - 12) % 12 + 12) % 12;
    el.className = [1,3,6,8,10].includes(s) ? 'black-key' : 'white-key';
  }

  function mark(midi, cls) {
    if (midi === null) return;
    const el = document.getElementById('key-' + midi);
    if (el) el.classList.add(cls);
  }

  // ç§»èª¿ã‚’é©ç”¨
  const tch = applyTranspose(ch);
  const tcl = applyTranspose(cl);
  const tfh = applyTranspose(fh);

  if (tch !== null && tcl !== null)
    for (let m = Math.min(tch,tcl); m <= Math.max(tch,tcl); m++) mark(m, 'key-range-chest');
  if (tfh !== null) mark(tfh, 'key-range-falsetto');

  mark(tch, 'key-chest-high');
  mark(tcl, 'key-chest-low');
  mark(tfh, 'key-falsetto-high');

  // éŸ³åŸŸè¡¨ç¤ºãƒ‘ãƒãƒ«æ›´æ–°ï¼ˆç§»èª¿å¾Œã®éŸ³åï¼‰
  updateRangeDisplay(tch, tcl, tfh);
}
const PIANO_START = 45;  // A2
const PIANO_END   = 115; // G7

function buildPiano() {
  const kb  = document.getElementById('keyboard');
  const lbl = document.getElementById('pianoLabels');
  kb.innerHTML = lbl.innerHTML = '';

  const whitePos = {};
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const s = ((m - 12) % 12 + 12) % 12;
    if (![1,3,6,8,10].includes(s)) whitePos[m] = Object.keys(whitePos).length;
  }

  const total = Object.keys(whitePos).length * 22;
  kb.style.width = kb.style.minWidth = total + 'px';
  lbl.style.width = total + 'px';

  // White keys
  Object.entries(whitePos).forEach(([m, wi]) => {
    m = parseInt(m);
    const s = ((m - 12) % 12 + 12) % 12;
    const d = document.createElement('div');
    d.className = 'white-key';
    d.id = 'key-' + m;
    kb.appendChild(d);
  });

  // Black keys
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const s = ((m - 12) % 12 + 12) % 12;
    if (![1,3,6,8,10].includes(s)) continue;
    let prev = null;
    for (let p = m - 1; p >= PIANO_START; p--) {
      if (whitePos[p] !== undefined) { prev = p; break; }
    }
    if (prev === null) continue;
    const d = document.createElement('div');
    d.className = 'black-key';
    d.id = 'key-' + m;
    d.style.left = (whitePos[prev] * 22 + 15) + 'px';
    d.style.top = '0';
    kb.appendChild(d);
  }

  // Labels â€” show at each A (start of Japanese octave)
  const OCTNAMES = ['ä½low','low','mid1','mid2','hi','hihi'];
  for (let m = PIANO_START; m <= PIANO_END; m++) {
    const s = ((m - 9) % 12 + 12) % 12; // 0 when note is A
    if (s !== 0) continue;
    // which octave group? A2=idx0, A3=idx1 ...
    const octIdx = Math.round((m - 45) / 12);
    if (octIdx < 0 || octIdx >= OCTNAMES.length) continue;
    const wi = whitePos[m];
    if (wi === undefined) continue;
    const sp = document.createElement('span');
    sp.className = 'octave-label';
    sp.style.left = (wi * 22 + 2) + 'px';
    sp.textContent = OCTNAMES[octIdx];
    lbl.appendChild(sp);
  }

  window._whitePos = whitePos;
}

function updatePiano() {
  drawPianoMidis(
    getNoteMidi('chestHigh'),
    getNoteMidi('chestLow'),
    getNoteMidi('falsettoHigh'),
  );
}

// â•â•â• Import / Export â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function exportRecords() {
  const data = JSON.stringify(records, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³åŸŸè¨˜éŒ²_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function openImportModal() {
  document.getElementById('importTextarea').value = '';
  document.getElementById('importResult').className = 'import-result';
  document.getElementById('importModal').classList.add('open');
}
function closeImportModal() {
  document.getElementById('importModal').classList.remove('open');
}

function doImport() {
  const raw = document.getElementById('importTextarea').value.trim();
  const resultEl = document.getElementById('importResult');
  let parsed;
  try {
    parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) throw new Error('é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
  } catch(e) {
    resultEl.textContent = 'JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + e.message;
    resultEl.className = 'import-result err';
    return;
  }

  const VALID_FIELDS = ['singer','song','chestHigh','chestLow','falsettoHigh'];
  let added = 0, skipped = 0;
  parsed.forEach(item => {
    if (typeof item !== 'object' || !item.singer || !item.song) { skipped++; return; }
    const isDup = records.some(r => r.singer === item.singer && r.song === item.song);
    if (isDup) { skipped++; return; }
    records.push({
      id: Date.now() + Math.random(),
      singer:       item.singer       || '',
      song:         item.song         || '',
      chestHigh:    item.chestHigh    || 'mid2A',
      chestLow:     item.chestLow     || 'ãªã—',
      falsettoHigh: item.falsettoHigh || 'ãªã—',
    });
    added++;
  });

  saveRecords();
  renderRecords();
  resultEl.textContent = `${added}ä»¶è¿½åŠ ã€${skipped}ä»¶ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`;
  resultEl.className = 'import-result ok';
  setTimeout(() => closeImportModal(), 1800);
}

document.getElementById('importModal').addEventListener('click', e => {
  if (e.target === document.getElementById('importModal')) closeImportModal();
});

// â•â•â• Records â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let records = JSON.parse(localStorage.getItem('vocalRecords') || '[]');
function saveRecords() { localStorage.setItem('vocalRecords', JSON.stringify(records)); }

function addRecord() {
  const singer = document.getElementById('singerName').value.trim();
  const song   = document.getElementById('songName').value.trim();
  if (!singer && !song) { document.getElementById('singerName').focus(); return; }

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const isDuplicate = records.some(r => r.singer === singer && r.song === song);
  if (isDuplicate) {
    const btn = document.getElementById('btnAdd');
    const msg = document.getElementById('duplicateMsg');
    btn.classList.add('shake');
    msg.classList.add('show');
    setTimeout(() => { btn.classList.remove('shake'); }, 400);
    setTimeout(() => { msg.classList.remove('show'); }, 3000);
    return;
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
  document.getElementById('duplicateMsg').classList.remove('show');

  records.unshift({
    id: Date.now(), singer, song,
    chestHigh:    getNoteName('chestHigh'),
    chestLow:     getNoteName('chestLow'),
    falsettoHigh: getNoteName('falsettoHigh'),
  });
  // è¿½åŠ ã—ãŸæ­Œæ‰‹ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è‡ªå‹•ã§é–‹ã
  const addedKey = singer || 'ï¼ˆåå‰ãªã—ï¼‰';
  const addedRowDef = KANA_ROWS.find(r => r.test(toHira(addedKey.charAt(0)))) || KANA_ROWS[KANA_ROWS.length - 1];
  const addedCharKey = getCharKey(addedRowDef, addedKey);
  openKanaRows.add(addedRowDef.key);
  openKanaChars.add(addedRowDef.key + ':' + addedCharKey);
  openSingers.add(addedKey);
  // æ›²åã®è¡Œã‚‚è‡ªå‹•ã§é–‹ã
  const songRowDef = KANA_ROWS.find(r => r.test(toHira((song||'').charAt(0)))) || KANA_ROWS[KANA_ROWS.length-1];
  openSongRows.add(addedKey + ':' + songRowDef.key);
  saveRecords();
  renderRecords();
}

function deleteRecord(id) {
  records = records.filter(r => r.id !== id);
  saveRecords();
  renderRecords();
}

function chestBadge(r) {
  if (r.chestLow === 'ãªã—') return `åœ°å£°ã€€æœ€é«˜éŸ³ ${r.chestHigh}`;
  return `åœ°å£°ã€€${r.chestLow} ã€œ ${r.chestHigh}`;
}

function falsettoBadge(r) {
  if (!r.falsettoHigh || r.falsettoHigh === 'ãªã—') return null;
  return `è£å£°ã€€æœ€é«˜éŸ³ ${r.falsettoHigh}`;
}

// ä¿å­˜æ¸ˆã¿ã®éŸ³åæ–‡å­—åˆ— â†’ MIDIç•ªå·ã«å¤‰æ›
function noteNameToMidi(name) {
  if (!name || name === 'ãªã—') return null;
  // prefixä¸€è¦§ã‚’é•·ã„é †ã«ãƒãƒƒãƒï¼ˆ"mid2" ãŒ "mid" ã‚ˆã‚Šå…ˆã«ãƒãƒƒãƒã™ã‚‹ã‚ˆã†ï¼‰
  const sorted = [...PREFIXES].sort((a,b) => b.label.length - a.label.length);
  let prefix = null, rest = '';
  for (const p of sorted) {
    if (name.startsWith(p.label)) { prefix = p; rest = name.slice(p.label.length); break; }
  }
  if (!prefix) return null;
  // rest = "A", "Bâ™¯", "Câ™­" ãªã©
  const noteName = rest.replace(/[â™¯â™­]/g, '');
  const accChar  = rest.includes('â™¯') ? 's' : rest.includes('â™­') ? 'f' : 'n';
  const note = NOTES.find(n => n.name === noteName);
  if (!note) return null;
  return Math.max(0, Math.min(127, prefix.midi + note.semi + ACC_OFFSET[accChar]));
}

// è¨˜éŒ²ã‚’éµç›¤ã«åæ˜ 
let activeRecordId = null;

function loadRecordToPianoMidis(r) {
  drawPianoMidis(
    noteNameToMidi(r.chestHigh),
    noteNameToMidi(r.chestLow),
    noteNameToMidi(r.falsettoHigh),
  );
}

function loadRecordToPiano(id) {
  if (activeRecordId === id) {
    activeRecordId = null;
    document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active'));
    document.getElementById('pianoLabel').textContent = 'ç¾åœ¨å…¥åŠ›ä¸­';
    updatePiano();
    return;
  }
  activeRecordId = id;
  document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active'));
  document.getElementById('rc-' + id)?.classList.add('active');

  const r = records.find(rec => rec.id === id);
  if (!r) return;

  // ãƒ©ãƒ™ãƒ«æ›´æ–°
  document.getElementById('pianoLabel').textContent = [r.singer, r.song].filter(Boolean).join(' / ');

  loadRecordToPianoMidis(r);
  document.querySelector('.piano-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// â•â•â• Edit Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EDIT_FIELD_IDS = ['chestHigh','chestLow','falsettoHigh'];
const editAccState  = { chestHigh:'n', chestLow:'n', falsettoHigh:'n' };
const editNoneState = { chestLow:false, falsettoHigh:false };
let editingRecordId = null;

function buildEditSelects() {
  EDIT_FIELD_IDS.forEach(id => {
    const ps = document.getElementById('e' + id + 'Prefix');
    const ns = document.getElementById('e' + id + 'Note');
    PREFIXES.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = p.label; ps.appendChild(o);
    });
    NOTES.forEach((n, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = n.name; ns.appendChild(o);
    });
    ps.addEventListener('change', () => updateEditDisplay(id));
    ns.addEventListener('change', () => updateEditDisplay(id));
  });
}

function setEditAcc(id, v) {
  editAccState[id] = v;
  document.querySelectorAll(`#eacc-${id} button`).forEach(b => {
    b.classList.toggle('sel', b.dataset.v === v);
  });
  updateEditDisplay(id);
}

function toggleEditNone(id) {
  editNoneState[id] = !editNoneState[id];
  const pill = document.getElementById('epill-' + id);
  const sel  = document.getElementById('esel-' + id);
  const disp = document.getElementById('edisp-' + id);
  pill.classList.toggle('active', editNoneState[id]);
  if (editNoneState[id]) {
    sel.classList.add('disabled');
    disp.textContent = 'ãªã—'; disp.classList.add('is-none');
  } else {
    sel.classList.remove('disabled');
    disp.classList.remove('is-none');
    updateEditDisplay(id);
  }
}

function getEditNoteName(id) {
  if (editNoneState[id]) return 'ãªã—';
  const pi = parseInt(document.getElementById('e' + id + 'Prefix').value);
  const ni = parseInt(document.getElementById('e' + id + 'Note').value);
  return PREFIXES[pi].label + NOTES[ni].name + ACC_LABEL[editAccState[id]];
}

function updateEditDisplay(id) {
  const disp = document.getElementById('edisp-' + id);
  if (!disp) return;
  if (editNoneState[id]) {
    disp.textContent = 'ãªã—'; disp.classList.add('is-none');
  } else {
    disp.textContent = getEditNoteName(id); disp.classList.remove('is-none');
  }
}

// éŸ³åæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã®selectã«åæ˜ 
function parseNoteToModal(id, noteName) {
  const isNoneVal = (!noteName || noteName === 'ãªã—');

  // noneStateã‚’ãƒªã‚»ãƒƒãƒˆ
  editNoneState[id] = false;
  const pill = document.getElementById('epill-' + id);
  const sel  = document.getElementById('esel-' + id);
  const disp = document.getElementById('edisp-' + id);

  if (isNoneVal && id !== 'chestHigh') {
    editNoneState[id] = true;
    if (pill) pill.classList.add('active');
    if (sel)  sel.classList.add('disabled');
    if (disp) { disp.textContent = 'ãªã—'; disp.classList.add('is-none'); }
    return;
  }
  if (pill) pill.classList.remove('active');
  if (sel)  sel.classList.remove('disabled');
  if (disp) disp.classList.remove('is-none');

  // ãƒ‘ãƒ¼ã‚¹
  const sorted = [...PREFIXES].sort((a,b) => b.label.length - a.label.length);
  let prefix = null, rest = '';
  for (const p of sorted) {
    if (noteName.startsWith(p.label)) { prefix = p; rest = noteName.slice(p.label.length); break; }
  }
  const accChar  = rest.includes('â™¯') ? 's' : rest.includes('â™­') ? 'f' : 'n';
  const noteChar = rest.replace(/[â™¯â™­]/g, '');
  const pi = PREFIXES.indexOf(prefix);
  const ni = NOTES.findIndex(n => n.name === noteChar);

  editAccState[id] = accChar;
  document.getElementById('e' + id + 'Prefix').value = pi >= 0 ? pi : 2;
  document.getElementById('e' + id + 'Note').value   = ni >= 0 ? ni : 0;
  document.querySelectorAll(`#eacc-${id} button`).forEach(b => {
    b.classList.toggle('sel', b.dataset.v === accChar);
  });
  updateEditDisplay(id);
}

function openEditModal(id) {
  const r = records.find(rec => rec.id === id);
  if (!r) return;
  editingRecordId = id;

  document.getElementById('editSingerName').value = r.singer || '';
  document.getElementById('editSongName').value   = r.song   || '';

  parseNoteToModal('chestHigh',    r.chestHigh);
  parseNoteToModal('chestLow',     r.chestLow);
  parseNoteToModal('falsettoHigh', r.falsettoHigh);

  document.getElementById('editModal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  editingRecordId = null;
}

function saveEdit() {
  const idx = records.findIndex(r => r.id === editingRecordId);
  if (idx < 0) return;
  records[idx] = {
    ...records[idx],
    singer:       document.getElementById('editSingerName').value.trim(),
    song:         document.getElementById('editSongName').value.trim(),
    chestHigh:    getEditNoteName('chestHigh'),
    chestLow:     getEditNoteName('chestLow'),
    falsettoHigh: getEditNoteName('falsettoHigh'),
  };
  saveRecords();
  closeEditModal();
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¼ãƒ‰ãŒç·¨é›†å¯¾è±¡ãªã‚‰éµç›¤ã‚‚æ›´æ–°
  if (activeRecordId === editingRecordId) loadRecordToPiano(editingRecordId);
  renderRecords();
}

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('editModal').addEventListener('click', e => {
  if (e.target === document.getElementById('editModal')) closeEditModal();
});

// äº”åéŸ³è¡Œã®å®šç¾©ï¼ˆå„è¡Œã®æ–‡å­—ä¸€è¦§ä»˜ãï¼‰
const KANA_ROWS = [
  { key: 'ã‚è¡Œ', label: 'ã‚è¡Œ', chars: ['ã‚','ã„','ã†','ãˆ','ãŠ'], test: c => 'ã‚ã„ã†ãˆãŠããƒã…ã‡ã‰ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚¡ã‚£ã‚¥ã‚§ã‚©'.includes(c) },
  { key: 'ã‹è¡Œ', label: 'ã‹è¡Œ', chars: ['ã‹','ã','ã','ã‘','ã“'], test: c => 'ã‹ããã‘ã“ãŒããã’ã”ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚¬ã‚®ã‚°ã‚²ã‚´'.includes(c) },
  { key: 'ã•è¡Œ', label: 'ã•è¡Œ', chars: ['ã•','ã—','ã™','ã›','ã'], test: c => 'ã•ã—ã™ã›ãã–ã˜ãšãœãã‚µã‚·ã‚¹ã‚»ã‚½ã‚¶ã‚¸ã‚ºã‚¼ã‚¾'.includes(c) },
  { key: 'ãŸè¡Œ', label: 'ãŸè¡Œ', chars: ['ãŸ','ã¡','ã¤','ã¦','ã¨'], test: c => 'ãŸã¡ã¤ã¦ã¨ã ã¢ã¥ã§ã©ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰'.includes(c) },
  { key: 'ãªè¡Œ', label: 'ãªè¡Œ', chars: ['ãª','ã«','ã¬','ã­','ã®'], test: c => 'ãªã«ã¬ã­ã®ãƒŠãƒ‹ãƒŒãƒãƒ'.includes(c) },
  { key: 'ã¯è¡Œ', label: 'ã¯è¡Œ', chars: ['ã¯','ã²','ãµ','ã¸','ã»'], test: c => 'ã¯ã²ãµã¸ã»ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½ãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ‘ãƒ”ãƒ—ãƒšãƒ'.includes(c) },
  { key: 'ã¾è¡Œ', label: 'ã¾è¡Œ', chars: ['ã¾','ã¿','ã‚€','ã‚','ã‚‚'], test: c => 'ã¾ã¿ã‚€ã‚ã‚‚ãƒãƒŸãƒ ãƒ¡ãƒ¢'.includes(c) },
  { key: 'ã‚„è¡Œ', label: 'ã‚„è¡Œ', chars: ['ã‚„','ã‚†','ã‚ˆ'],           test: c => 'ã‚„ã‚†ã‚ˆã‚ƒã‚…ã‚‡ãƒ¤ãƒ¦ãƒ¨ãƒ£ãƒ¥ãƒ§'.includes(c) },
  { key: 'ã‚‰è¡Œ', label: 'ã‚‰è¡Œ', chars: ['ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚'], test: c => 'ã‚‰ã‚Šã‚‹ã‚Œã‚ãƒ©ãƒªãƒ«ãƒ¬ãƒ­'.includes(c) },
  { key: 'ã‚è¡Œ', label: 'ã‚è¡Œ', chars: ['ã‚','ã‚’','ã‚“'],           test: c => 'ã‚ã‚’ã‚“ãƒ¯ãƒ²ãƒ³'.includes(c) },
  { key: 'A-Z',  label: 'A-Z',  chars: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), test: c => /^[a-zA-Z]$/.test(c) },
  { key: '0-9',  label: '0-9',  chars: '0123456789'.split(''),    test: c => /^[0-9ï¼-ï¼™]$/.test(c) },
  { key: 'ãã®ä»–',label: 'ãã®ä»–', chars: [],                     test: () => true },
];

// ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªå¤‰æ›
function toHira(c) {
  const code = c.charCodeAt(0);
  return (code >= 0x30A1 && code <= 0x30F6) ? String.fromCharCode(code - 0x60) : c;
}

function getKanaRow(singer) {
  const c = toHira((singer || '').charAt(0));
  for (const row of KANA_ROWS) {
    if (row.test(c)) return row.key;
  }
  return 'ãã®ä»–';
}

// æ­Œæ‰‹åã®å…ˆé ­æ–‡å­—ãŒè¡Œã®ä½•ç•ªç›®ã®æ–‡å­—ã«å¯¾å¿œã™ã‚‹ã‹
function getCharKey(rowDef, singer) {
  const c = toHira((singer || '').charAt(0));
  for (const rc of rowDef.chars) {
    const hrc = toHira(rc);
    // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã‚‚åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚Œã‚‹ï¼ˆã•â†’ã–ç³»ï¼‰
    if (c === hrc) return rc;
  }
  // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã¯ãƒ™ãƒ¼ã‚¹æ–‡å­—ã«å¯¾å¿œã•ã›ã‚‹
  for (const rc of rowDef.chars) {
    const hrc = toHira(rc);
    const baseCode = hrc.charCodeAt(0);
    const cCode    = c.charCodeAt(0);
    if (cCode === baseCode + 1 || cCode === baseCode + 2) return rc;
  }
  return rowDef.chars[0] || (singer || '').charAt(0);
}

// é–‹ã„ã¦ã„ã‚‹è¡Œãƒ»ä¸­é–“æ–‡å­—ãƒ»æ­Œæ‰‹ãƒ»æ›²åè¡Œã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¨˜æ†¶
const openKanaRows  = new Set();
const openKanaChars = new Set();
const openSingers   = new Set();
const openSongRows  = new Set(); // "singerKey:rowKey" ã®è¤‡åˆã‚­ãƒ¼

function toggleKanaRow(key) {
  openKanaRows.has(key) ? openKanaRows.delete(key) : openKanaRows.add(key);
  renderRecords();
}
function toggleKanaChar(key) {
  openKanaChars.has(key) ? openKanaChars.delete(key) : openKanaChars.add(key);
  renderRecords();
}
function toggleSingerGroup(singerKey) {
  openSingers.has(singerKey) ? openSingers.delete(singerKey) : openSingers.add(singerKey);
  renderRecords();
}
function toggleSongRow(key) {
  openSongRows.has(key) ? openSongRows.delete(key) : openSongRows.add(key);
  renderRecords();
}

function renderRecords() {
  const list = document.getElementById('recordList');
  if (!records.length) {
    list.innerHTML = '<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  list.innerHTML = '';

  // æ­Œæ‰‹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒ»äº”åéŸ³é †
  const singerMap = {};
  records.forEach(r => {
    const k = r.singer || 'ï¼ˆåå‰ãªã—ï¼‰';
    if (!singerMap[k]) singerMap[k] = [];
    singerMap[k].push(r);
  });
  const singerKeys = Object.keys(singerMap).sort((a, b) => a.localeCompare(b, 'ja'));
  singerKeys.forEach(k => {
    singerMap[k].sort((a, b) => (a.song||'').localeCompare(b.song||'', 'ja'));
  });

  // è¡Œ â†’ ä¸­é–“æ–‡å­— â†’ æ­Œæ‰‹ ã®3éšå±¤ãƒãƒƒãƒ—
  const rowMap = {}; // rowKey â†’ { charKey â†’ [singerKey] }
  singerKeys.forEach(singerKey => {
    const rowDef = KANA_ROWS.find(r => r.test(toHira((singerKey).charAt(0)))) || KANA_ROWS[KANA_ROWS.length - 1];
    const rowKey = rowDef.key;
    const charKey = getCharKey(rowDef, singerKey);
    if (!rowMap[rowKey]) rowMap[rowKey] = {};
    if (!rowMap[rowKey][charKey]) rowMap[rowKey][charKey] = [];
    rowMap[rowKey][charKey].push(singerKey);
  });

  // å®šç¾©é †ã§å­˜åœ¨ã™ã‚‹è¡Œã ã‘è¡¨ç¤º
  KANA_ROWS.forEach(rowDef => {
    const charMap = rowMap[rowDef.key];
    if (!charMap) return;

    const allSingers = Object.values(charMap).flat();
    const totalSongs = allSingers.reduce((s, k) => s + singerMap[k].length, 0);
    const isRowOpen  = openKanaRows.has(rowDef.key);

    // â”€â”€ å±¤1ï¼šè¡Œã‚°ãƒ«ãƒ¼ãƒ— â”€â”€
    const kanaGroup = document.createElement('div');
    kanaGroup.className = 'kana-group';

    const kanaHeader = document.createElement('div');
    kanaHeader.className = 'kana-header' + (isRowOpen ? ' open' : '');
    kanaHeader.innerHTML = `
      <div class="kana-badge">${rowDef.label.charAt(0)}</div>
      <div class="kana-info">
        <div class="kana-label">${rowDef.label}</div>
        <div class="kana-sub">${allSingers.length}äººãƒ»${totalSongs}æ›²</div>
      </div>
      <span class="kana-chevron">â–¼</span>
    `;
    kanaHeader.addEventListener('click', () => toggleKanaRow(rowDef.key));

    const kanaBody = document.createElement('div');
    kanaBody.className = 'kana-body' + (isRowOpen ? ' open' : '');

    // ä¸­é–“æ–‡å­—ã‚’è¡Œã®å®šç¾©é †ã§è¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
    const orderedChars = rowDef.chars.length > 0
      ? rowDef.chars.filter(c => charMap[c])
      : Object.keys(charMap).sort((a,b) => a.localeCompare(b, 'ja'));

    orderedChars.forEach(charKey => {
      const singers = charMap[charKey] || [];
      if (!singers.length) return;
      const charTotalSongs = singers.reduce((s, k) => s + singerMap[k].length, 0);
      const compositeKey   = rowDef.key + ':' + charKey;
      const isCharOpen     = openKanaChars.has(compositeKey);

      // â”€â”€ å±¤2ï¼šä¸­é–“æ–‡å­—ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã•ãƒ»ã—ãƒ»ã™â€¦ï¼‰ â”€â”€
      const charGroup = document.createElement('div');
      charGroup.className = 'char-group';

      const charHeader = document.createElement('div');
      charHeader.className = 'char-header' + (isCharOpen ? ' open' : '');
      charHeader.innerHTML = `
        <span class="char-badge">${charKey}</span>
        <span class="char-count">${singers.length}äººãƒ»${charTotalSongs}æ›²</span>
        <span class="char-chevron">â–¼</span>
      `;
      charHeader.addEventListener('click', () => toggleKanaChar(compositeKey));

      const charBody = document.createElement('div');
      charBody.className = 'char-body' + (isCharOpen ? ' open' : '');

      // â”€â”€ å±¤3ï¼šæ­Œæ‰‹ã‚°ãƒ«ãƒ¼ãƒ— â”€â”€
      singers.forEach(singerKey => {
        const singerRecords = singerMap[singerKey];
        const isSingerOpen  = openSingers.has(singerKey);

        const group = document.createElement('div');
        group.className = 'singer-group';

        const header = document.createElement('div');
        header.className = 'singer-header' + (isSingerOpen ? ' open' : '');
        header.innerHTML = `
          <div class="singer-header-left">
            <div class="singer-avatar">${singerKey.charAt(0)}</div>
            <div>
              <div class="singer-name-label">${singerKey}</div>
              <div class="singer-count">${singerRecords.length}æ›²</div>
            </div>
          </div>
          <div class="singer-header-right">
            <span class="singer-chevron">â–¼</span>
          </div>
        `;
        header.addEventListener('click', () => toggleSingerGroup(singerKey));

        const songs = document.createElement('div');
        songs.className = 'singer-songs' + (isSingerOpen ? ' open' : '');

        // æ›²åã‚’è¡Œï¼ˆã‚è¡Œãƒ»ã‹è¡Œâ€¦ï¼‰ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const songRowMap = {}; // rowKey â†’ [record]
        singerRecords.forEach(r => {
          const rDef = KANA_ROWS.find(rd => rd.test(toHira((r.song||'').charAt(0)))) || KANA_ROWS[KANA_ROWS.length-1];
          if (!songRowMap[rDef.key]) songRowMap[rDef.key] = { def: rDef, recs: [] };
          songRowMap[rDef.key].recs.push(r);
        });

        KANA_ROWS.forEach(rDef => {
          const group = songRowMap[rDef.key];
          if (!group) return;
          const srKey   = singerKey + ':' + rDef.key;
          const isOpen  = openSongRows.has(srKey);

          const rowGroup = document.createElement('div');
          rowGroup.className = 'song-row-group';

          const rowHeader = document.createElement('div');
          rowHeader.className = 'song-row-header' + (isOpen ? ' open' : '');
          rowHeader.innerHTML = `
            <span class="song-row-badge">${rDef.label.charAt(0)}</span>
            <span class="song-row-count">${rDef.label}ã€€${group.recs.length}æ›²</span>
            <span class="song-row-chevron">â–¼</span>
          `;
          rowHeader.addEventListener('click', () => toggleSongRow(srKey));

          const rowBody = document.createElement('div');
          rowBody.className = 'song-row-body' + (isOpen ? ' open' : '');

          group.recs.forEach(r => {
            const fb   = falsettoBadge(r);
            const card = document.createElement('div');
            card.className = 'record-card' + (activeRecordId === r.id ? ' active' : '');
            card.id = 'rc-' + r.id;
            card.innerHTML = `
              <div style="cursor:pointer;flex:1" onclick="loadRecordToPiano(${r.id})">
                <div class="record-song" style="margin-bottom:6px">${r.song || 'â€”'}</div>
                <div class="record-ranges">
                  <span class="range-badge badge-chest">${chestBadge(r)}</span>
                  ${fb ? `<span class="range-badge badge-falsetto">${fb}</span>` : ''}
                </div>
                <div class="tap-hint">ã‚¿ãƒƒãƒ—ã—ã¦éµç›¤ã«è¡¨ç¤º</div>
              </div>
              <div class="card-actions">
                <button class="btn-edit"   onclick="event.stopPropagation();openEditModal(${r.id})">ç·¨é›†</button>
                <button class="btn-delete" onclick="event.stopPropagation();deleteRecord(${r.id})">å‰Šé™¤</button>
              </div>
            `;
            rowBody.appendChild(card);
          });

          rowGroup.appendChild(rowHeader);
          rowGroup.appendChild(rowBody);
          songs.appendChild(rowGroup);
        });

        group.appendChild(header);
        group.appendChild(songs);
        charBody.appendChild(group);
      });

      charGroup.appendChild(charHeader);
      charGroup.appendChild(charBody);
      kanaBody.appendChild(charGroup);
    });

    kanaGroup.appendChild(kanaHeader);
    kanaGroup.appendChild(kanaBody);
    list.appendChild(kanaGroup);
  });
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildSelects();
buildEditSelects();
buildPiano();
updatePiano();
renderRecords();

// â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
